{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ campaign.name }} - Campaign Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">
                    <i class="bi bi-megaphone me-2"></i>
                    {{ campaign.name }}
                </h1>
                <p class="page-subtitle">
                    Campaign Details & Team Monitoring
                    {% if campaign.client_name %}
                    • Client: {{ campaign.client_name }}
                    {% endif %}
                </p>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    <a href="{% url 'management_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>
                        Back to Dashboard
                    </a>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-filter me-2"></i>
                            Filter: {{ selected_period|title }}
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item {% if selected_period == '7days' %}active{% endif %}" href="?period=7days">Last 7 Days</a></li>
                            <li><a class="dropdown-item {% if selected_period == '30days' %}active{% endif %}" href="?period=30days">Last 30 Days</a></li>
                            <li><a class="dropdown-item {% if selected_period == '90days' %}active{% endif %}" href="?period=90days">Last 90 Days</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item {% if selected_period == 'current_month' %}active{% endif %}" href="?period=current_month">Current Month</a></li>
                            <li><a class="dropdown-item {% if selected_period == 'previous_month' %}active{% endif %}" href="?period=previous_month">Previous Month</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-primary text-uppercase small fw-bold">Team Size</div>
                            <div class="number display-6 fw-bold text-primary">{{ total_employees }}</div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    {{ campaign.head_count }} target • 
                                    {{ campaign_metrics.headcount_utilization|floatformat:0 }}% utilized
                                </small>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people text-primary fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-success text-uppercase small fw-bold">Schedule Compliance</div>
                            <div class="number display-6 fw-bold text-success">{{ schedule_compliance_rate }}%</div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    {{ actual_attendance_today }} of {{ scheduled_today }} scheduled
                                </small>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-calendar-check text-success fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-info text-uppercase small fw-bold">Total Hours</div>
                            <div class="number display-6 fw-bold text-info">{{ campaign_metrics.total_hours|floatformat:0 }}</div>
                            <div class="mt-2">
                                <small class="text-muted">{{ campaign_metrics.avg_productivity }}h/day avg</small>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-clock text-info fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-warning text-uppercase small fw-bold">Online Now</div>
                            <div class="number display-6 fw-bold text-warning">{{ logged_in_count }}</div>
                            <div class="mt-2">
                                <small class="text-muted">{{ campaign_metrics.attendance_rate }}% of team</small>
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-person-check text-warning fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shift Coverage for Campaign -->
    {% if shift_coverage_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Shift Coverage - Today
                    </h5>
                    <span class="badge bg-secondary">{{ shift_coverage_data|length }} shifts</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Shift</th>
                                    <th>Time Range</th>
                                    <th>Scheduled</th>
                                    <th>Checked In</th>
                                    <th>Coverage Rate</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for shift_data in shift_coverage_data %}
                                <tr>
                                    <td>
                                        <strong>{{ shift_data.shift.name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ shift_data.shift.shift_type|title }}</small>
                                    </td>
                                    <td>
                                        <span class="badge" style="background-color: {{ shift_data.shift.color_code }};">
                                            {{ shift_data.shift.formatted_time_range }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="fw-bold">{{ shift_data.scheduled_count }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ shift_data.checked_in_count }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                                <div class="progress-bar 
                                                    {% if shift_data.coverage_rate >= 90 %}bg-success
                                                    {% elif shift_data.coverage_rate >= 75 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    style="width: {{ shift_data.coverage_rate }}%">
                                                </div>
                                            </div>
                                            <small>{{ shift_data.coverage_rate }}%</small>
                                        </div>
                                    </td>
                                    <td>
                                        {% if shift_data.is_understaffed %}
                                            <span class="badge bg-danger">Understaffed</span>
                                        {% else %}
                                            <span class="badge bg-success">Good</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Campaign Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Campaign Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">Timeline Completion</span>
                                    <span class="badge bg-primary">{{ campaign_metrics.completion_percentage }}%</span>
                                </div>
                                <div class="progress" style="height: 12px;">
                                    <div class="progress-bar 
                                        {% if campaign_metrics.completion_percentage >= 80 %}bg-success
                                        {% elif campaign_metrics.completion_percentage >= 50 %}bg-warning
                                        {% else %}bg-info{% endif %}" 
                                        style="width: {{ campaign_metrics.completion_percentage }}%">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-muted">Start: {{ campaign.start_date }}</small>
                                    <small class="text-muted">End: {{ campaign.end_date }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Status</span>
                                    <span class="badge {% if campaign.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ campaign.is_active|yesno:"Active,Inactive" }}
                                    </span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Productivity Avg</span>
                                    <span class="fw-bold {% if campaign_metrics.avg_productivity >= 6 %}text-success{% else %}text-warning{% endif %}">
                                        {{ campaign_metrics.avg_productivity }}h
                                    </span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Schedule Compliance</span>
                                    <span class="fw-bold {% if schedule_compliance_rate >= 90 %}text-success{% elif schedule_compliance_rate >= 75 %}text-warning{% else %}text-danger{% endif %}">
                                        {{ schedule_compliance_rate }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Status Grid -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-person-lines-fill me-2"></i>
                Team Members ({{ total_employees }})
            </h5>
            <div class="d-flex align-items-center">
                <span class="badge bg-info me-2">Scheduled</span>
                <span class="badge bg-success me-2">Online</span>
                <span class="badge bg-secondary me-2">Offline</span>
                <span class="badge bg-warning me-2">Break</span>
                <button id="refresh-btn" class="btn btn-sm btn-outline-primary ms-2">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Employee</th>
                            <th>Department</th>
                            <th>Scheduled Shift</th>
                            <th>Status</th>
                            <th>Work Time</th>
                            <th>Today's Hours</th>
                            <th>Last Login</th>
                        </tr>
                    </thead>
                    <tbody id="team-status-body">
                        {% for data in employee_data %}
                        <tr>
                            <td>
                                <a href="{% url 'employee_attendance_detail' data.employee.id %}">
                                    <strong>{{ data.employee.full_name }}</strong>
                                </a>
                                <br>
                                <small class="text-muted">{{ data.employee.position }}</small>
                            </td>
                            <td>{{ data.employee.department.name }}</td>
                            <td>
                                {% if data.is_scheduled_today %}
                                    <div>
                                        <span class="badge" style="background-color: {{ data.scheduled_shift.color_code }};">
                                            {{ data.scheduled_shift.name }}
                                        </span>
                                        <br>
                                        <small class="text-muted">{{ data.scheduled_shift.formatted_time_range }}</small>
                                    </div>
                                {% else %}
                                    <span class="text-muted">Not scheduled</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if data.workday %}
                                    {% if data.workday.current_status != 'inactive' %}
                                        <span class="badge 
                                            {% if data.workday.current_status == 'work' %}bg-success
                                            {% elif data.workday.current_status == 'break' %}bg-warning
                                            {% elif data.workday.current_status == 'lunch' %}bg-info
                                            {% else %}bg-primary{% endif %}">
                                            <i class="bi 
                                                {% if data.workday.current_status == 'work' %}bi-play-circle
                                                {% elif data.workday.current_status == 'break' %}bi-cup-hot
                                                {% elif data.workday.current_status == 'lunch' %}bi-egg-fried
                                                {% else %}bi-gear{% endif %} me-1"></i>
                                            {{ data.workday.current_status|title }}
                                        </span><br>
                                        <small class="text-muted">
                                            {% if data.current_session %}
                                                Since {{ data.current_session.start_time|time:"g:i A" }}
                                            {% endif %}
                                        </small>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-pause-circle me-1"></i>
                                            Offline
                                        </span>
                                        {% if data.is_scheduled_today %}
                                            <br><small class="text-warning">Should be working</small>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-light text-dark">
                                        <i class="bi bi-dash-circle me-1"></i>
                                        No Workday
                                    </span>
                                    {% if data.is_scheduled_today %}
                                        <br><small class="text-danger">Absent (scheduled)</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if data.current_session and data.current_session.start_time %}
                                    <span class="live-counter"
                                          data-employee="{{ data.employee.id }}"
                                          data-start="{{ data.current_session.start_time|date:'c' }}">
                                          00:00:00
                                    </span>
                                {% else %}
                                    <span class="text-muted">No active session</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if data.daily_stats and data.daily_stats.total_work_time %}
                                    <span class="fw-bold text-primary">
                                        {{ data.daily_stats.total_work_time }}
                                    </span>
                                    {% if data.scheduled_shift %}
                                        <br>
                                        <small class="text-muted">
                                            / {{ data.scheduled_shift.expected_hours }}h expected
                                        </small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if data.employee.user.last_login %}
                                    {{ data.employee.user.last_login|date:"M j, g:i A" }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                        </tr>   
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                No employees found in this campaign.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Schedule Compliance Trends -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calendar-heart me-2"></i>
                        Schedule Compliance Trends - {{ selected_period|title }}
                    </h5>
                    <span class="badge bg-secondary">{{ attendance_trends|length }} days</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Scheduled</th>
                                    <th>Present</th>
                                    <th>Compliance Rate</th>
                                    <th>Trend</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trend in attendance_trends %}
                                <tr>
                                    <td>
                                        <strong>{{ trend.date|date:"M d, Y" }}</strong>
                                        {% if trend.is_today %}
                                        <span class="badge bg-primary ms-1">Today</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ trend.scheduled_count }}</span>
                                    </td>
                                    <td>
                                        <span class="fw-bold text-success">{{ trend.actual_count }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 6px; width: 100px;">
                                                <div class="progress-bar 
                                                    {% if trend.compliance_rate >= 90 %}bg-success
                                                    {% elif trend.compliance_rate >= 75 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    style="width: {{ trend.compliance_rate }}%">
                                                </div>
                                            </div>
                                            <span class="fw-bold {% if trend.compliance_rate >= 90 %}text-success{% elif trend.compliance_rate >= 75 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ trend.compliance_rate }}%
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if trend.trend_direction == 'up' %}
                                            <i class="bi bi-arrow-up-circle text-success" title="Improving"></i>
                                        {% elif trend.trend_direction == 'down' %}
                                            <i class="bi bi-arrow-down-circle text-danger" title="Declining"></i>
                                        {% else %}
                                            <i class="bi bi-dash-circle text-muted" title="Stable"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if trend.compliance_rate >= 90 %}
                                            <span class="badge bg-success">Excellent</span>
                                        {% elif trend.compliance_rate >= 75 %}
                                            <span class="badge bg-warning">Good</span>
                                        {% else %}
                                            <span class="badge bg-danger">Needs Improvement</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Timer Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Live counters functionality
    const counters = new Map();

    function updateCounters() {
        counters.forEach((data, id) => {
            if (!data.active) return;
            const now = new Date();
            let diff = Math.floor((now - data.startTime) / 1000);
            if (diff < 0) diff = 0;
            const hours = Math.floor(diff / 3600);
            diff %= 3600;
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            data.element.textContent =
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        });
    }

    function initializeCounters() {
        document.querySelectorAll('.live-counter').forEach(span => {
            const id = span.dataset.employee;
            const startTime = new Date(span.dataset.start);
            counters.set(id, { element: span, startTime, active: true });
        });
    }

    function resetInactiveCounters() {
        counters.forEach((data, id) => {
            if (!document.querySelector(`.live-counter[data-employee="${id}"]`)) {
                data.active = false;
                data.element.classList.add('text-muted');
            }
        });
    }

    initializeCounters();
    setInterval(updateCounters, 1000);

    // Auto-refresh functionality
    function refreshTeamStatus() {
        fetch(window.location.href)
            .then(res => res.text())
            .then(html => {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const newBody = doc.getElementById('team-status-body');
                if (newBody) {
                    document.getElementById('team-status-body').innerHTML = newBody.innerHTML;
                    initializeCounters();
                    resetInactiveCounters();
                }
            })
            .catch(err => console.error('Error refreshing team status:', err));
    }

    document.getElementById('refresh-btn').addEventListener('click', refreshTeamStatus);
    // Auto-refresh every 30 seconds
    setInterval(refreshTeamStatus, 30000);
});
</script>

<style>
.number {
    font-size: 2.5rem;
}
.progress {
    background-color: #e9ecef;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    color: #6c757d;
}

.badge {
    font-size: 0.75rem;
}

.live-counter {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}
</style>
{% endblock %}
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Employee ID Cards</h1>
            <p class="text-muted">Select employees to generate ID cards</p>
        </div>
        <div class="d-flex gap-2">
            <!-- Selected Counter -->
            <div class="selected-counter me-3">
                <span class="badge bg-primary fs-6" id="selectedCount">
                    {{ selected_count }} selected
                </span>
            </div>
            
            <!-- Action Buttons -->
            <button class="btn btn-success" id="generatePdfBtn" {% if selected_count == 0 %}disabled{% endif %}>
                <i class="bi bi-file-pdf me-2"></i>Generate PDF{% if selected_count > 0 %} ({{ selected_count }}){% endif %}
            </button>
            <button class="btn btn-outline-danger" id="clearSelectionBtn" 
                    data-clear-url="{% url 'clear_id_cards_selection' %}"
                    {% if selected_count == 0 %}disabled{% endif %}>
                <i class="bi bi-x-circle me-2"></i>Clear
            </button>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3" id="filterForm">
                <!-- Search -->
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" name="search" 
                           value="{{ search_query }}" placeholder="Name">
                </div>
                
                <!-- Department Filter -->
                <div class="col-md-2">
                    <label class="form-label">Department</label>
                    <select class="form-select" name="department">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}" 
                                {% if filters.department == dept.id|stringformat:"s" %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Position Filter -->
                <div class="col-md-2">
                    <label class="form-label">Position</label>
                    <select class="form-select" name="position">
                        <option value="">All Positions</option>
                        {% for pos in positions %}
                        <option value="{{ pos.id }}"
                                {% if filters.position == pos.id|stringformat:"s" %}selected{% endif %}>
                            {{ pos.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Campaign Filter -->
                <div class="col-md-2">
                    <label class="form-label">Campaign</label>
                    <select class="form-select" name="campaign">
                        <option value="">All Campaigns</option>
                        {% for camp in campaigns %}
                        <option value="{{ camp.id }}"
                                {% if filters.campaign == camp.id|stringformat:"s" %}selected{% endif %}>
                            {{ camp.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="">All Status</option>
                        <option value="logged_in" {% if filters.status == 'logged_in' %}selected{% endif %}>
                            Logged In
                        </option>
                        <option value="logged_out" {% if filters.status == 'logged_out' %}selected{% endif %}>
                            Logged Out
                        </option>
                    </select>
                </div>
                
                <!-- Filter Buttons -->
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employees Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="50" class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>Employee</th>
                            <th>Position</th>
                            <th>Department</th>
                            <th>Campaign</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in page_obj %}
                        <tr class="employee-row" 
                            data-employee-id="{{ employee.id }}"
                            data-toggle-url="{% url 'toggle_employee_selection' employee.id %}">
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input employee-checkbox" 
                                           type="checkbox" 
                                           value="{{ employee.id }}"
                                           {% if employee.id in selected_employees %}checked{% endif %}>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div>
                                        <h6 class="mb-0">
                                            {{ employee.user.get_full_name|default:employee.user.username }}
                                        </h6>
                                        <small class="text-muted">{{ employee.employee_code }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if employee.position %}
                                    {{ employee.position.name }}
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if employee.department %}
                                    <span class="badge bg-light text-dark">{{ employee.department.name }}</span>
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if employee.current_campaign %}
                                    <span class="badge bg-info">{{ employee.current_campaign.name }}</span>
                                {% else %}
                                    <span class="text-muted">No campaign</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-people display-4 d-block mb-2"></i>
                                    No employees found matching your criteria.
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                    <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Generating ID Cards...</p>
            </div>
        </div>
    </div>
</div>

<!-- Contenedor para carnets (oculto pero renderizado) -->
<div id="idCardsContainer" class="offscreen">
    {% for employee in page_obj %}
    <div class="card-pair printable-card" data-employee-id="{{ employee.id }}">
        <!-- FRONT SIDE -->
        <div class="idcard-cr80 idcard-front">
            <div class="idcard-header">
                    <div>
                        <img src="{% static 'img/company_logo.png' %}" class="idcard-logo" alt="Logo">
                        <p class="">HELIUM HEALTH</p>
                    </div>
                <div class="idcard-year">2025</div>
            </div>

            <div class="idcard-body">
                <div class="idcard-left">
                    <div class="idcard-first">
                        {{ employee.user.first_name|upper }}
                    </div>
                    <div class="idcard-last">
                        {{ employee.user.last_name|upper }}
                    </div>
                    <div class="idcard-title">
                        {% if employee.position %} 
                            {{ employee.position.name|upper }}
                        {% else %}
                            EMPLOYEE
                        {% endif %}
                    </div>
                    <div class="idcard-dept">
                        {% if employee.department %}
                            {{ employee.department.name|upper }}
                        {% else %}
                            DEPARTMENT
                        {% endif %}
                    </div>
                </div>

                <div class="idcard-photo">
                    {% if employee.profile_picture %}
                        <img src="{{ employee.profile_picture.url }}" alt="{{ employee.user.get_full_name }}" crossorigin="anonymous">
                    {% else %}
                        <div class="photo-placeholder">
                            {% if employee.user.first_name and employee.user.last_name %}
                                {{ employee.user.first_name.0 }}{{ employee.user.last_name.0 }}
                            {% else %}
                                {{ employee.user.username.0|upper }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- BACK SIDE -->
        <div class="idcard-cr80 idcard-back">
            <div class="idcard-back-top">
                <img src="{% static 'img/company_logo.png' %}" class="idcard-back-logo" alt="Logo">
            </div>

            <div class="idcard-back-text">
                There is a time for everything, and a season for every activity under the heavens:
                a time to be born and a time to die, a time to plant and a time to uproot what is planted.
            </div>

            <div class="idcard-back-ref">
                Ecclesiastes 3:1-2
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const selectedCountBadge = document.getElementById("selectedCount");
    const generatePdfBtn = document.getElementById("generatePdfBtn");
    const clearBtn = document.getElementById("clearSelectionBtn");
    const selectAllCheckbox = document.getElementById("selectAll");
    
    // Todas las filas visibles en esta página
    const employeeRows = document.querySelectorAll(".employee-row");

    // -------------------------------
    // 1. Toggle individual (AJAX)
    // -------------------------------
    employeeRows.forEach(row => {
        const checkbox = row.querySelector(".employee-checkbox");
        const toggleUrl = row.dataset.toggleUrl;

        checkbox.addEventListener("change", function () {
            fetch(toggleUrl, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "X-Requested-With": "XMLHttpRequest",
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateCounter(data.selected_count);
                }
            });
        });
    });


    // -------------------------------
    // 2. Select All
    // -------------------------------
    selectAllCheckbox.addEventListener("change", function () {
        const isChecked = this.checked;

        employeeRows.forEach(row => {
            const checkbox = row.querySelector(".employee-checkbox");

            // Evitar dobles requests innecesarios
            if (checkbox.checked !== isChecked) {
                checkbox.checked = isChecked;
                row.querySelector(".employee-checkbox").dispatchEvent(new Event("change"));
            }
        });
    });


    // -------------------------------
    // 3. Clear selection
    // -------------------------------
    clearBtn.addEventListener("click", function () {
        const url = this.dataset.clearUrl;

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCSRFToken(),
                "X-Requested-With": "XMLHttpRequest",
            },
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {

                // reset UI
                employeeRows.forEach(row => {
                    row.querySelector(".employee-checkbox").checked = false;
                });

                selectAllCheckbox.checked = false;

                updateCounter(0);
            }
        });
    });


    // -------------------------------
    // 4. Generate PDF
    // Solo imprime los empleados seleccionados
    // -------------------------------
    generatePdfBtn.addEventListener("click", function () {

        const selectedIds = [];

        document.querySelectorAll(".employee-checkbox:checked").forEach(chk => {
            selectedIds.push(parseInt(chk.value));
        });

        if (selectedIds.length === 0) {
            alert("Select at least one employee");
            return;
        }

        // Mostrar modal de carga
        const loadingModal = new bootstrap.Modal(document.getElementById("loadingModal"));
        loadingModal.show();

        // container donde están todos los carnets ocultos
        const allCards = document.querySelectorAll(".printable-card");
        
        // Clonar solo los carnets seleccionados
        const printableWrapper = document.createElement("div");
        printableWrapper.classList.add("pdf-wrapper");

        allCards.forEach(card => {
            const empId = parseInt(card.dataset.employeeId);

            if (selectedIds.includes(empId)) {
                printableWrapper.appendChild(card.cloneNode(true));
            }
        });

        // Opciones para html2pdf
        const opt = {
            margin:       [5, 5, 5, 5],
            filename:     'employee_id_cards.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  {
                scale: 2,
                dpi: 600,
                letterRendering: true,
                useCORS: true
            },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Generar PDF
        html2pdf()
            .set(opt)
            .from(printableWrapper)
            .save()
            .then(() => {
                loadingModal.hide();
            });
    });


    // -------------------------------
    // Helpers
    // -------------------------------
    function updateCounter(count) {
        selectedCountBadge.innerText = `${count} selected`;

        if (count > 0) {
            generatePdfBtn.disabled = false;
            clearBtn.disabled = false;
        } else {
            generatePdfBtn.disabled = true;
            clearBtn.disabled = true;
        }
    }

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

});
</script>


<style>

.card-pair {
    display: flex;
    justify-content: center;
    gap: 10mm;
    page-break-inside: avoid;
    margin-bottom: 15mm;
}


.idcard-photo img {
    width: 100,max-width: 100%;
    height: 100%;
    object-fit: cover;
}

.photo-placeholder {
    width: 100%;
    height: 100%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    color: #6c757d;
}


</style>

{% endblock %}
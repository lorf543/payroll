{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Employee ID Cards</h1>
            <p class="text-muted">Select employees to generate ID cards</p>
        </div>
        <div class="d-flex gap-2">
            <!-- Selected Counter -->
            <div class="selected-counter me-3">
                <span class="badge bg-primary fs-6" id="selectedCount">
                    {{ selected_count }} selected
                </span>
            </div>
            
            <!-- Action Buttons -->
            <button class="btn btn-success" id="generatePdfBtn">
                <i class="bi bi-file-pdf me-2"></i>Generate PDF{% if selected_count > 0 %} ({{ selected_count }}){% endif %}
            </button>
            <button class="btn btn-outline-danger" id="clearSelectionBtn" 
                    data-clear-url="{% url 'clear_id_cards_selection' %}"
                    >
                <i class="bi bi-x-circle me-2"></i>Clear
            </button>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3" id="filterForm">
                <!-- Search -->
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" name="search" 
                           value="{{ search_query }}" placeholder="Name">
                </div>
                
                <!-- Department Filter -->
                <div class="col-md-2">
                    <label class="form-label">Department</label>
                    <select class="form-select" name="department">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}" 
                                {% if filters.department == dept.id|stringformat:"s" %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Position Filter -->
                <div class="col-md-2">
                    <label class="form-label">Position</label>
                    <select class="form-select" name="position">
                        <option value="">All Positions</option>
                        {% for pos in positions %}
                        <option value="{{ pos.id }}"
                                {% if filters.position == pos.id|stringformat:"s" %}selected{% endif %}>
                            {{ pos.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Campaign Filter -->
                <div class="col-md-2">
                    <label class="form-label">Campaign</label>
                    <select class="form-select" name="campaign">
                        <option value="">All Campaigns</option>
                        {% for camp in campaigns %}
                        <option value="{{ camp.id }}"
                                {% if filters.campaign == camp.id|stringformat:"s" %}selected{% endif %}>
                            {{ camp.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="">All Status</option>
                        <option value="logged_in" {% if filters.status == 'logged_in' %}selected{% endif %}>
                            Logged In
                        </option>
                        <option value="logged_out" {% if filters.status == 'logged_out' %}selected{% endif %}>
                            Logged Out
                        </option>
                    </select>
                </div>
                
                <!-- Filter Buttons -->
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employees Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="50" class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            <th>Employee</th>
                            <th>Position</th>
                            <th>Department</th>
                            <th>Campaign</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in page_obj %}
                        <tr class="employee-row" 
                            data-employee-id="{{ employee.id }}"
                            data-toggle-url="{% url 'toggle_employee_selection' employee.id %}">
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input employee-checkbox" 
                                           type="checkbox" 
                                           value="{{ employee.id }}"
                                           {% if employee.id in selected_employees %}checked{% endif %}>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div>
                                        <h6 class="mb-0">
                                            {{ employee.user.get_full_name|default:employee.user.username }}
                                        </h6>
                                        <small class="text-muted">{{ employee.employee_code }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if employee.position %}
                                    {{ employee.position.name }}
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if employee.department %}
                                    <span class="badge bg-light text-dark">{{ employee.department.name }}</span>
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if employee.current_campaign %}
                                    <span class="badge bg-info">{{ employee.current_campaign.name }}</span>
                                {% else %}
                                    <span class="text-muted">No campaign</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-people display-4 d-block mb-2"></i>
                                    No employees found matching your criteria.
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                    <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Generating ID Cards...</p>
                <small class="text-muted" id="progressText">Preparing documents...</small>
            </div>
        </div>
    </div>
</div>

<!-- Contenedor para carnets (oculto pero renderizado) -->
<div id="idCardsContainer" class="offscreen">
    {% for employee in page_obj %}
    <div class="card-pair printable-card" data-employee-id="{{ employee.id }}">
        <!-- FRONT SIDE -->
        <div class="idcard-cr80 idcard-front">
            <div class="idcard-header">
                <div>
                    <img src="{% static 'img/company_logo.png' %}" class="idcard-logo" alt="Logo">
                    <p class="">HELIUM HEALTH</p>
                </div>
                <div class="idcard-year">2025</div>
            </div>

            <div class="idcard-body">
                <div class="idcard-left">
                    <div class="idcard-first">
                        {{ employee.user.first_name|upper }}
                    </div>
                    <div class="idcard-last">
                        {{ employee.user.last_name|upper }}
                    </div>
                    <div class="idcard-title">
                        {% if employee.position %} 
                            {{ employee.position.name|upper }}
                        {% else %}
                            EMPLOYEE
                        {% endif %}
                    </div>
                    <div class="idcard-dept">
                        {% if employee.department %}
                            {{ employee.department.name|upper }}
                        {% else %}
                            DEPARTMENT
                        {% endif %}
                    </div>
                </div>

                <div class="idcard-photo">
                    {% if employee.profile_picture %}
                        <img src="{{ employee.profile_picture.url }}" alt="{{ employee.user.get_full_name }}" crossorigin="anonymous">
                    {% else %}
                        <div class="photo-placeholder">
                            {% if employee.user.first_name and employee.user.last_name %}
                                {{ employee.user.first_name.0 }}{{ employee.user.last_name.0 }}
                            {% else %}
                                {{ employee.user.username.0|upper }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- BACK SIDE -->
        <div class="idcard-cr80 idcard-back">
            <div class="idcard-back-top">
                <img src="{% static 'img/company_logo.png' %}" class="idcard-back-logo" alt="Logo">
            </div>

            <div class="idcard-back-text">
                There is a time for everything, and a season for every activity under the heavens:
                a time to be born and a time to die, a time to plant and a time to uproot what is planted.
            </div>

            <div class="idcard-back-ref">
                Ecclesiastes 3:1-2
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Incluir las librerías necesarias -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* Estilos para los carnets */




.card-pair {
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 5mm;
    margin-bottom: 15mm;
    page-break-after: always;

}



/* Estilos para impresión */
@media print {
    body * {
        visibility: hidden;
    }
    #idCardsContainer, #idCardsContainer * {
        visibility: visible;
    }
    #idCardsContainer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    .card-pair {
        page-break-after: always;
        page-break-inside: avoid;
    }
    .card-pair:last-child {
        page-break-after: avoid;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const selectAllCheckbox = document.getElementById('selectAll');
    const employeeCheckboxes = document.querySelectorAll('.employee-checkbox');
    const selectedCount = document.getElementById('selectedCount');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    const progressText = document.getElementById('progressText');

    // Seleccionar/Deseleccionar todos
    selectAllCheckbox.addEventListener('change', function() {
        employeeCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });

    // Actualizar contador de seleccionados
    function updateSelectedCount() {
        const selected = document.querySelectorAll('.employee-checkbox:checked').length;
        selectedCount.textContent = `${selected} selected`;
        generatePdfBtn.innerHTML = `<i class="bi bi-file-pdf me-2"></i>Generate PDF${selected > 0 ? ` (${selected})` : ''}`;
    }

    employeeCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });

    // Limpiar selección
    clearSelectionBtn.addEventListener('click', function() {
        const clearUrl = this.getAttribute('data-clear-url');
        
        fetch(clearUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                employeeCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectAllCheckbox.checked = false;
                updateSelectedCount();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Selection cleared',
                    text: 'All employees have been deselected.',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to clear selection.'
            });
        });
    });

    // Generar PDF
    generatePdfBtn.addEventListener('click', async function() {
        const selectedEmployees = Array.from(document.querySelectorAll('.employee-checkbox:checked'))
            .map(checkbox => checkbox.value);

        if (selectedEmployees.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'No employees selected',
                text: 'Please select at least one employee to generate ID cards.'
            });
            return;
        }

        loadingModal.show();
        await generatePDF(selectedEmployees);
    });

    // Función para generar PDF
    async function generatePDF(selectedEmployeeIds) {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        const cardPairs = document.querySelectorAll('.card-pair');
        const selectedCards = Array.from(cardPairs).filter(card => {
            const employeeId = card.getAttribute('data-employee-id');
            return selectedEmployeeIds.includes(employeeId);
        });

        if (selectedCards.length === 0) {
            loadingModal.hide();
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No ID cards found for selected employees.'
            });
            return;
        }

        try {
            for (let i = 0; i < selectedCards.length; i++) {
                progressText.textContent = `Processing card ${i + 1} of ${selectedCards.length}`;
                
                const cardPair = selectedCards[i];
                
                // Crear un contenedor temporal para capturar
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'fixed';
                tempContainer.style.left = '0';
                tempContainer.style.top = '0';
                tempContainer.style.width = '210mm';
                tempContainer.style.height = '297mm';
                tempContainer.style.backgroundColor = 'white';
                tempContainer.style.zIndex = '9999';
                tempContainer.style.padding = '20mm';
                tempContainer.style.boxSizing = 'border-box';
                
                // Clonar el card pair
                const clonedCard = cardPair.cloneNode(true);
                clonedCard.style.margin = '0';
                clonedCard.style.transform = 'scale(1)';
                
                tempContainer.appendChild(clonedCard);
                document.body.appendChild(tempContainer);

                // Capturar con html2canvas
                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });

                // Limpiar contenedor temporal
                document.body.removeChild(tempContainer);

                const imgData = canvas.toDataURL('image/png');
                
                // Agregar nueva página si no es la primera
                if (i > 0) {
                    pdf.addPage();
                }

                // Agregar imagen al PDF
                pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
            }

            // Guardar PDF
            pdf.save(`employee_id_cards_${new Date().toISOString().split('T')[0]}.pdf`);
            
            loadingModal.hide();
            
            Swal.fire({
                icon: 'success',
                title: 'PDF Generated',
                text: `Successfully generated ${selectedCards.length} ID card(s)`,
                timer: 2000,
                showConfirmButton: false
            });

        } catch (error) {
            console.error('Error generating PDF:', error);
            loadingModal.hide();
            
            Swal.fire({
                icon: 'error',
                title: 'Generation Failed',
                text: 'An error occurred while generating the PDF. Please try again.'
            });
        }
    }

    // Función auxiliar para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Inicializar contador
    updateSelectedCount();
});
</script>
{% endblock %}
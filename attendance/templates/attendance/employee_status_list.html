{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container mt-4">
    <!-- Messages Display -->
    {% if messages %}
    <div class="messages-container mb-4">
        {% for message in messages %}
        <div class="alert alert-dismissible {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">
            <i class="bi bi-person-badge"></i>
            Status history for <strong>{{ employee.user.get_full_name }}</strong> â€” {{ today }} 
        </h4>
        
        <!-- Force Logout Button -->
        {% if request.user.employee.is_supervisor and employee.supervisor == request.user.employee %}
        <form method="post" action="{% url 'employee_force_logout' employee.id %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm" 
                    onclick="return confirm('Are you sure you want to force logout {{ employee.user.get_full_name }}?')">
                <i class="bi bi-box-arrow-right"></i> Force Logout
            </button>
        </form>
        {% endif %}
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>Status</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Duration</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                {% for s in statuses %}
                <tr>
                    <td>
                        <span class="badge status-{{ s.status }} px-3 py-2">
                            {{ s.status|title }}
                        </span>
                    </td>
                    <td>{{ s.start_time|date:"M j, g:i A" }}</td>
                    <td>
                        {% if s.end_time %}
                            {{ s.end_time|date:"M j, g:i A" }}
                        {% else %}
                            <span class="text-success fw-semibold">Active</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if s.natural_duration %}
                            {{ s.natural_duration }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if s.notes %}
                            {{ s.notes }}
                        {% else %}
                            <button type="button" class="btn btn-outline-success btn-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#addNoteModal{{ s.id }}">
                                Add Note
                            </button>
                        {% endif %}
                    </td>
                </tr>
                
                <!-- Note Modal for each status record -->
                <div class="modal fade" id="addNoteModal{{ s.id }}" tabindex="-1" aria-labelledby="addNoteModalLabel{{ s.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addNoteModalLabel{{ s.id }}">
                                    Add Note for {{ s.status|title }} Status
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="post" action="{% url 'add_status_note' s.id %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="notes{{ s.id }}" class="form-label">Notes</label>
                                        <textarea class="form-control" id="notes{{ s.id }}" name="notes" rows="4" 
                                                  placeholder="Add notes about this status period..."></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Note</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-clock-history display-6 d-block mb-2"></i>
                        No status records for today
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <a href="{% url 'supervisor_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<style>
.status-ready { background-color: #28a745; color: white; }
.status-break { background-color: #ffc107; color: black; }
.status-lunch { background-color: #6c757d; color: white; }
.status-training { background-color: #007bff; color: white; }
.status-meeting { background-color: #dc3545; color: white; }
.status-offline { background-color: #343a40; color: white; }

.messages-container {
    position: relative;
    z-index: 1000;
}
</style>

<script>
// Auto-hide messages after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
});
</script>
{% endblock %}
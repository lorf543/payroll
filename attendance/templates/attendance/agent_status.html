{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">Agent Status Dashboard</h1>
                <p class="page-subtitle">Manage your availability and track your status</p>

                <div id="current-status">
                    {% include "attendance/partials/current_status.html" %}
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Update Your Status</h5>
                    </div>
                    <div class="card-body">
                        {% include "attendance/partials/status_form.html" %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h4 class="card-title mb-0">Today's Summary</h6>
                        <a href="{% url 'payroll_dashboard' %}">Payroll Dashboard</a>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total Time:</span> <strong>{{ daily_stats.total }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Payable Time:</span> <strong>{{ daily_stats.payable }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Breaks:</span> <strong>{{ daily_stats.break }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Lunch:</span> <strong>{{ daily_stats.lunch }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Estimated Total Earned:</span> <strong>${{ daily_stats.money }}</strong>
                        </li>

                    </ul>
                </div>
            </div>
        </div>

        <!-- Tabla de historial -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Daily History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="history-table" class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Duration</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for rec in history %}
                                    <tr>
                                        <td>{{ rec.status|capfirst }}</td>
                                        <td>{{ rec.start_time|date:"h:i:s" }}</td>
                                        <td>
                                            {% if rec.end_time %}
                                                {{ rec.end_time|date:"h:i:s" }}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td>{{ rec.duration_str }}</td>
                                        <td>{{ rec.notes }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
.status-ready { background-color: #28a745; color: white; }
.status-break { background-color: #ffc107; color: black; }
.status-lunch { background-color: #6c757d; color: white; }
.status-training { background-color: #007bff; color: white; }
.status-meeting { background-color: #dc3545; color: white; }
.status-offline { background-color: #343a40; color: white; }

#id_status {
    transition: all 0.3s ease;
    cursor: pointer;
}

.status-form select option {
    color: black;
    background: white;
    font-weight: normal;
}
</style>

<!-- Scripts -->
<script>
// Contador en vivo
function initializeLiveCounter() {
    const liveTimeEl = document.getElementById("live-time");
    if (!liveTimeEl) return;

    const startTimeStr = liveTimeEl.dataset.startTime;
    const startTime = new Date(startTimeStr);

    function updateRelativeTime() {
        const now = new Date();
        let seconds = Math.floor((now - startTime) / 1000);

        let days = Math.floor(seconds / 86400);
        seconds %= 86400;
        let hours = Math.floor(seconds / 3600);
        seconds %= 3600;
        let minutes = Math.floor(seconds / 60);
        seconds %= 60;

        let parts = [];
        if (days > 0) parts.push(`${days} day${days !== 1 ? 's' : ''}`);
        if (hours > 0) parts.push(`${hours} hour${hours !== 1 ? 's' : ''}`);
        if (minutes > 0) parts.push(`${minutes} minute${minutes !== 1 ? 's' : ''}`);
        parts.push(`${seconds} second${seconds !== 1 ? 's' : ''}`);

        liveTimeEl.textContent = parts.join(' ') + " ago";
    }

    if (window.liveTimeInterval) clearInterval(window.liveTimeInterval);
    updateRelativeTime();
    window.liveTimeInterval = setInterval(updateRelativeTime, 1000);
}

// Preview del badge cuando cambias select
function initializeStatusPreview() {
    const select = document.getElementById('id_status');
    const badge = document.getElementById('status-badge-preview');
    const statusClassMap = {
        'ready': 'status-ready',
        'break': 'status-break',
        'lunch': 'status-lunch',
        'training': 'status-training',
        'meeting': 'status-meeting',
        'offline': 'status-offline'
    };

    if (select && badge) {
        select.addEventListener('change', () => {
            const sel = select.value;
            const cls = statusClassMap[sel] || 'status-offline';
            badge.className = 'badge px-3 py-2 ' + cls;
            badge.textContent = select.options[select.selectedIndex].text;
        });
    }
}



document.addEventListener('DOMContentLoaded', () => {
    initializeLiveCounter();
    initializeStatusPreview();
    initializeHistoryTable();
});

// Re-inicializar después de HTMX swap
document.body.addEventListener('htmx:afterSwap', (e) => {
    // Si el fragmento current-status fue reemplazado
    if (document.getElementById('live-time')) {
        initializeLiveCounter();
    }
    initializeStatusPreview();
});
</script>

<!-- DataTables: agrega jQuery y DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

{% endblock %}

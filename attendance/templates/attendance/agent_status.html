{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-fluid">
    <!-- Messages Display -->
    {% if messages %}
    <div class="messages-container mb-4">
        {% for message in messages %}
        <div class="alert alert-dismissible {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">Agent Status Dashboard</h1>
                <p class="page-subtitle">Manage your availability and track your status</p>

                <div id="current-status">
                    {% include "attendance/partials/current_status.html" %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">Update Your Status</h5>
                </div>
                <div class="card-body">
                    {% include "attendance/partials/status_form.html" %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Today's Summary</h5>
                    <a href="{% url 'payroll_dashboard' %}" class="btn btn-outline-primary btn-sm">
                        Payroll Dashboard
                    </a>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Total Time:</span> 
                            <strong>{{ daily_stats.total }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Payable Time:</span> 
                            <strong class="text-success">{{ daily_stats.payable }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Breaks:</span> 
                            <strong class="text-warning">{{ daily_stats.break }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Lunch:</span> 
                            <strong class="text-info">{{ daily_stats.lunch }}</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Payable Hours:</span> 
                            <strong>{{ daily_stats.payable_hours }}h</strong>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                            <span class="fw-bold">Estimated Earnings:</span> 
                            <strong class="text-success">${{ daily_stats.money }}</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de historial -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Daily History</h5>
                    <small class="text-muted">{{ today|date:"F j, Y" }}</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="" class="table table-striped table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Status</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Duration</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rec in history %}
                                <tr>
                                    <td>
                                        <span class="badge status-{{ rec.status }} px-2 py-1">
                                            {{ rec.status|capfirst }}
                                        </span>
                                    </td>
                                    <td>{{ rec.start_time|date:"g:i A" }}</td>
                                    <td>
                                        {% if rec.end_time %}
                                            {{ rec.end_time|date:"g:i A" }}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ rec.duration_str }}</strong></td>
                                    <td>
                                        {% if rec.notes %}
                                            <small class="text-muted">{{ rec.notes }}</small>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="bi bi-clock-history display-4 d-block mb-2"></i>
                                        No activity recorded today
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.status-ready { background-color: #28a745; color: white; }
.status-break { background-color: #ffc107; color: black; }
.status-lunch { background-color: #6c757d; color: white; }
.status-training { background-color: #007bff; color: white; }
.status-meeting { background-color: #dc3545; color: white; }
.status-offline { background-color: #343a40; color: white; }

#id_status {
    transition: all 0.3s ease;
    cursor: pointer;
}

.status-form select option {
    color: black;
    background: white;
    font-weight: normal;
}

.messages-container {
    position: relative;
    z-index: 1000;
}

/* Smooth transitions for status changes */
.status-badge {
    transition: all 0.3s ease;
}

/* Auto-hide messages after 5 seconds */
.alert {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<!-- Scripts -->
<script>
// Auto-hide messages after 5 seconds
function autoHideMessages() {
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
}

// Contador en vivo
function initializeLiveCounter() {
    const liveTimeEl = document.getElementById("live-time");
    if (!liveTimeEl) return;

    const startTimeStr = liveTimeEl.dataset.startTime;
    const startTime = new Date(startTimeStr);

    function updateRelativeTime() {
        const now = new Date();
        let seconds = Math.floor((now - startTime) / 1000);

        let days = Math.floor(seconds / 86400);
        seconds %= 86400;
        let hours = Math.floor(seconds / 3600);
        seconds %= 3600;
        let minutes = Math.floor(seconds / 60);
        seconds %= 60;

        let parts = [];
        if (days > 0) parts.push(`${days}d`);
        if (hours > 0) parts.push(`${hours}h`);
        if (minutes > 0) parts.push(`${minutes}m`);
        parts.push(`${seconds}s`);

        liveTimeEl.textContent = parts.join(' ');
    }

    if (window.liveTimeInterval) clearInterval(window.liveTimeInterval);
    updateRelativeTime();
    window.liveTimeInterval = setInterval(updateRelativeTime, 1000);
}

// Preview del badge cuando cambias select
function initializeStatusPreview() {
    const select = document.getElementById('id_status');
    const badge = document.getElementById('status-badge-preview');
    const statusClassMap = {
        'ready': 'status-ready',
        'break': 'status-break',
        'lunch': 'status-lunch',
        'training': 'status-training',
        'meeting': 'status-meeting',
        'offline': 'status-offline'
    };

    if (select && badge) {
        select.addEventListener('change', () => {
            const sel = select.value;
            const cls = statusClassMap[sel] || 'status-offline';
            badge.className = 'badge px-3 py-2 ' + cls;
            badge.textContent = select.options[select.selectedIndex].text;
        });
    }
}

// Initialize DataTable
function initializeHistoryTable() {
    if ($.fn.DataTable) {
        $('#history-table').DataTable({
            "pageLength": 10,
            "order": [[1, 'desc']],
            "language": {
                "search": "Search history:",
                "lengthMenu": "Show _MENU_ entries",
                "info": "Showing _START_ to _END_ of _TOTAL_ entries",
                "infoEmpty": "No entries available",
                "emptyTable": "No activity recorded today"
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    autoHideMessages();
    initializeLiveCounter();
    initializeStatusPreview();
    initializeHistoryTable();
});

// Re-inicializar después de HTMX swap
document.body.addEventListener('htmx:afterSwap', (e) => {
    if (document.getElementById('live-time')) {
        initializeLiveCounter();
    }
    initializeStatusPreview();
    autoHideMessages();
});
</script>

<!-- DataTables: agrega jQuery y DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

{% endblock %}
<div class="activity-controls">
    <!-- Status Change Form -->
    <form id="statusForm" method="post" action="{% url 'start_activity' %}" class="mb-4">
        {% csrf_token %}
        <div class="mb-3">
            <label for="session_type" class="form-label fw-bold">Change Status</label>
            <select name="session_type" id="session_type" class="form-select form-select-lg" required>
                <option value="work" {% if current_session and current_session.session_type == 'work' %}selected{% endif %}>Work</option>
                <option value="break" {% if current_session and current_session.session_type == 'break' %}selected{% endif %}>Break</option>
                <option value="lunch" {% if current_session and current_session.session_type == 'lunch' %}selected{% endif %}>Lunch</option>
                <option value="training" {% if current_session and current_session.session_type == 'training' %}selected{% endif %}>Training</option>
                <option value="meeting" {% if current_session and current_session.session_type == 'meeting' %}selected{% endif %}>Meeting</option>
                <option value="technical" {% if current_session and current_session.session_type == 'technical' %}selected{% endif %}>Technical Issue</option>
                <option value="end_of_day" {% if current_session and current_session.session_type == 'end_of_day' %}selected{% endif %}>End Work Day</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="notes" class="form-label">Notes (Optional)</label>
            <textarea name="notes" id="notes" class="form-control" rows="2" placeholder="Add any notes about this status change..."></textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100 btn-lg">
            Update Status
        </button>
    </form>

    <!-- Current Status Display -->
    <div class="current-status-info p-3 bg-light rounded">
        <h6 class="fw-bold mb-2">Current Status</h6>
        {% if current_session %}
        <div class="d-flex justify-content-between align-items-center">
            <span class="badge status-{{ current_session.session_type }} px-3 py-2">
                {{ current_session.get_session_type_display }}
            </span>
            <div class="text-end">
                <small class="text-muted d-block">Started: {{ current_session.start_time|date:"g:i A" }}</small>
                <div id="live-duration" class="fw-bold text-primary">
                    <small>Duration: <span id="duration-counter">Calculating...</span></small>
                </div>
                {% if current_session.session_type in "break lunch" %}
                <div id="time-remaining-container" class="fw-bold text-danger">
                    <small>Time remaining: <span id="countdownTimer">Calculating...</span></small>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-2">
            <i class="bi bi-dash-circle d-block fs-2 mb-2"></i>
            No active status
        </div>
        {% endif %}
    </div>

    <!-- Status Legend -->
    <div class="mt-3 p-3 bg-light rounded">
        <h6 class="fw-bold mb-2">Status Legend</h6>
        <div class="d-flex flex-wrap gap-1">
            <span class="badge status-work">Work</span>
            <span class="badge status-break">Break</span>
            <span class="badge status-lunch">Lunch</span>
            <span class="badge status-training">Training</span>
            <span class="badge status-meeting">Meeting</span>
            <span class="badge status-technical">Technical</span>
        </div>
    </div>
</div>

<!-- Modal de confirmaciÃ³n para Break/Lunch -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Status Change</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>You are about to change your status to <strong id="selectedStatusText"></strong>.</p>
        <p>You should return by <span id="returnTimeText" class="fw-bold"></span>.</p>
        <p class="text-muted small">Do you want to proceed?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmStatusChange">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
    // Get break and lunch duration from database
    const BREAK_DURATION = {{ campaign.break_duraction }};
    const LUNCH_DURATION = {{ campaign.lunch }};

    // Variables globales para almacenar datos temporales
    let pendingSessionType = null;
    let pendingFormData = null;

    // âœ… Cambiar color de fondo segÃºn estado
    function updateBodyColor(sessionType) {
        const classes = [
            'status-work','status-break','status-lunch',
            'status-training','status-meeting','status-technical',
            'status-end_of_day'
        ];
        document.body.classList.remove(...classes);
        if(sessionType) document.body.classList.add(`status-${sessionType}`);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const statusSelect = document.getElementById('session_type');
        const form = document.getElementById('statusForm');
        const currentStatus = "{{ current_session.session_type|default:'' }}";
        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        const confirmButton = document.getElementById('confirmStatusChange');

        updateBodyColor(currentStatus);

        // ðŸš« Evitar seleccionar el mismo estado
        statusSelect.addEventListener('change', function() {
            if (this.value === currentStatus) {
                Swal.fire({
                    icon: 'info',
                    title: 'No status change',
                    text: `You are already in "${currentStatus}" status.`,
                    timer: 1500,
                    showConfirmButton: false,
                    position: 'top-end'
                });
                this.value = currentStatus;
            }
        });

        // âœ… Manejar submit - Nuevo flujo
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const selected = statusSelect.value;
            
            // ValidaciÃ³n: no permitir cambiar al mismo estado
            if (selected === currentStatus) {
                return;
            }

            // Preparar datos del formulario
            pendingFormData = new FormData(form);
            pendingSessionType = selected;

            // Flujo diferente para break/lunch vs otros estados
            if (selected === 'break' || selected === 'lunch') {
                // Mostrar modal de confirmaciÃ³n con hora de retorno
                showConfirmationModal(selected);
            } else {
                // Para otros estados, proceder directamente
                await submitStatusChange();
            }
        });

        // âœ… Confirmar cambio de estado (cuando el usuario presiona el botÃ³n Confirm)
        confirmButton.addEventListener('click', async function() {
            confirmationModal.hide();
            await submitStatusChange();
        });
    });

    // âœ… Mostrar modal de confirmaciÃ³n para break/lunch
    function showConfirmationModal(sessionType) {
        const minutes = sessionType === 'break' ? BREAK_DURATION : LUNCH_DURATION;
        const returnTime = calculateReturnTime(minutes);
        
        // Actualizar texto del modal
        document.getElementById('selectedStatusText').textContent = sessionType;
        document.getElementById('returnTimeText').textContent = returnTime;
        
        // Mostrar modal
        const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        confirmationModal.show();
    }

    // âœ… Calcular hora de retorno
    function calculateReturnTime(minutes) {
        const returnTime = new Date();
        returnTime.setMinutes(returnTime.getMinutes() + minutes);

        let hours = returnTime.getHours();
        const mins = returnTime.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;

        return `${hours}:${mins} ${ampm}`;
    }

    // âœ… Enviar cambio de estado al servidor
    async function submitStatusChange() {
        if (!pendingFormData) return;

        try {
            const response = await fetch("{% url 'start_activity' %}", {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: pendingFormData
            });

            if (response.ok) {
                updateBodyColor(pendingSessionType);
                Swal.fire({
                    position: "top-end",
                    icon: "success",
                    title: `Status changed to "${pendingSessionType}" successfully!`,
                    showConfirmButton: false,
                    timer: 1200,
                    didClose: () => {
                        window.location.reload();
                    }
                });
            } else {
                Swal.fire({ 
                    icon: 'error', 
                    title: 'Error', 
                    text: 'Error updating status.' 
                });
            }
        } catch (err) {
            console.error(err);
            Swal.fire({ 
                icon: 'error', 
                title: 'Error', 
                text: 'Error sending request.' 
            });
        } finally {
            // Limpiar datos temporales
            pendingFormData = null;
            pendingSessionType = null;
        }
    }

    // â±ï¸ Contador de duraciÃ³n + tiempo restante (solo break/lunch)
    function updateDurationCounter() {
        const currentType = "{{ current_session.session_type|default:'' }}";
        const currentSession = {% if current_session %}{
            startTime: new Date('{{ current_session.start_time|date:"c" }}')
        }{% else %}null{% endif %};

        if (!currentSession) return;

        const counterEl = document.getElementById('duration-counter');
        const countdownEl = document.getElementById('countdownTimer');
        let endTime = null;

        // Si es break/lunch, define el tiempo lÃ­mite usando valores de la base de datos
        if (currentType === 'break' || currentType === 'lunch') {
            const minutes = currentType === 'break' ? BREAK_DURATION : LUNCH_DURATION;
            endTime = new Date(currentSession.startTime.getTime() + minutes * 60000);
        }

        function update() {
            const now = new Date();
            const diffMs = now - currentSession.startTime;
            const diffSeconds = Math.floor(diffMs / 1000);
            const hours = Math.floor(diffSeconds / 3600);
            const minutes = Math.floor((diffSeconds % 3600) / 60);
            const seconds = diffSeconds % 60;

            if (counterEl) {
                const durationText =
                    hours > 0
                        ? `${hours}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`
                        : `${minutes.toString().padStart(2,'0')}m ${seconds.toString().padStart(2,'0')}s`;
                counterEl.textContent = durationText;
            }

            if (endTime && countdownEl) {
                const diff = endTime - now;
                if (diff <= 0) {
                    countdownEl.textContent = "Time's up!";
                    countdownEl.classList.add("text-danger");
                    Swal.fire({
                        icon: "warning",
                        title: currentType === "break" ? "Break ended!" : "Lunch ended!",
                        text: "Your time has ended. Please return to work.",
                        timer: 5000,
                        showConfirmButton: true
                    });
                    endTime = null; // Evita mÃºltiples alertas
                    return;
                }
                const minsLeft = Math.floor(diff / 60000);
                const secsLeft = Math.floor((diff % 60000) / 1000);
                countdownEl.textContent = `${minsLeft}m ${secsLeft.toString().padStart(2,'0')}s`;
            }
        }

        update();
        setInterval(update, 1000);
    }

    document.addEventListener('DOMContentLoaded', updateDurationCounter);
</script>
<div class="activity-controls">
    <!-- Status Change Form -->
<form id="statusForm" method="post" action="{% url 'start_activity' %}" class="mb-4">
        {% csrf_token %}
        <div class="mb-3">
            <label for="session_type" class="form-label fw-bold">Change Status</label>
                <select name="session_type" id="session_type" class="form-select form-select-lg" required>
                    <option value="work" {% if current_session and current_session.session_type == 'work' %}selected{% endif %}>Work</option>
                    <option value="break" {% if current_session and current_session.session_type == 'break' %}selected{% endif %}>Break</option>
                    <option value="lunch" {% if current_session and current_session.session_type == 'lunch' %}selected{% endif %}>Lunch</option>
                    <option value="training" {% if current_session and current_session.session_type == 'training' %}selected{% endif %}>Training</option>
                    <option value="meeting" {% if current_session and current_session.session_type == 'meeting' %}selected{% endif %}>Meeting</option>
                    <option value="technical" {% if current_session and current_session.session_type == 'technical' %}selected{% endif %}>Technical Issue</option>
                    <option value="end_of_day" {% if current_session and current_session.session_type == 'end_of_day' %}selected{% endif %}>End Work Day</option>
                </select>
        </div>
        
        <div class="mb-3">
            <label for="notes" class="form-label">Notes (Optional)</label>
            <textarea name="notes" id="notes" class="form-control" rows="2" 
                      placeholder="Add any notes about this status change..."></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary w-100 btn-lg">
            Update Status
        </button>
    </form>

    <!-- Current Status Display -->
    <div class="current-status-info p-3 bg-light rounded">
        <h6 class="fw-bold mb-2">Current Status</h6>
        {% if current_session %}
        <div class="d-flex justify-content-between align-items-center">
            <span class="badge status-{{ current_session.session_type }} px-3 py-2">
                {{ current_session.get_session_type_display }}
            </span>
            <div class="text-end">
                <small class="text-muted d-block">Started: {{ current_session.start_time|date:"g:i A" }}</small>
                <div id="live-duration" class="fw-bold text-primary">
                    <small>Duration: <span id="duration-counter">Calculating...</span></small>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-2">
            <i class="bi bi-dash-circle d-block fs-2 mb-2"></i>
            No active status
        </div>
        {% endif %}
    </div>

    <!-- Status Legend -->
    <div class="mt-3 p-3 bg-light rounded">
        <h6 class="fw-bold mb-2">Status Legend</h6>
        <div class="d-flex flex-wrap gap-1">
            <span class="badge status-work">Work</span>
            <span class="badge status-break">Break</span>
            <span class="badge status-lunch">Lunch</span>
            <span class="badge status-training">Training</span>
            <span class="badge status-meeting">Meeting</span>
            <span class="badge status-technical">Technical</span>
        </div>
    </div>
</div>
<!-- Modal Bootstrap -->
<div class="modal fade" id="returnTimeModal" tabindex="-1" aria-labelledby="returnTimeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="returnTimeModalLabel">Break/Lunch Info</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        You should return by <span id="returnTimeText"></span>.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
// FunciÃ³n para actualizar el color del body segÃºn el estado
function updateBodyColor(sessionType) {
    const classes = [
        'status-work','status-break','status-lunch',
        'status-training','status-meeting','status-technical',
        'status-end_of_day'
    ];
    document.body.classList.remove(...classes);
    if(sessionType) document.body.classList.add(`status-${sessionType}`);
}

document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('session_type');
    const form = document.getElementById('statusForm');

    // Estado actual del usuario
    const currentStatus = "{{ current_session.session_type|default:'' }}";

    // Inicial: mostrar color del estado actual
    updateBodyColor(currentStatus);

    // Manejo del cambio de estado
    statusSelect.addEventListener('change', function() {
        if (this.value === currentStatus) {
            Swal.fire({
                icon: 'info',
                title: 'No status change',
                text: `You are already in "${currentStatus}" status.`,
                timer: 1500,
                showConfirmButton: false,
                position: 'top-end'
            });
            this.value = currentStatus; // Mantener el estado original
        }
    });

    // Manejo del submit
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const selected = statusSelect.value;

        // ðŸš« Evitar enviar request si es el mismo estado
        if (selected === currentStatus) {
            Swal.fire({
                icon: 'info',
                title: 'No status change',
                text: `You are already in "${currentStatus}" status.`,
                timer: 1500,
                showConfirmButton: false,
                position: 'top-end'
            });
            return;
        }

        const formData = new FormData(form);

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            });

            if (response.ok) {
                // Solo despuÃ©s de que backend confirme el cambio
                updateBodyColor(selected);

                // SweetAlert de Ã©xito
                Swal.fire({
                    position: "top-end",
                    icon: "success",
                    title: `Status changed to "${selected}" successfully!`,
                    showConfirmButton: false,
                    timer: 1500,
                    didOpen: () => {
                        document.body.style.transition = "background-color 0.5s ease";
                    }
                });

                // Recargar la pÃ¡gina o actualizar dinÃ¡micamente
                window.location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error updating status.'
                });
            }
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error sending request.'
            });
        }
    });
});

// ðŸ•’ Modal de break/lunch
function showReturnTime(minutes) {
    const returnTime = new Date();
    returnTime.setMinutes(returnTime.getMinutes() + minutes);

    let hours = returnTime.getHours();
    const mins = returnTime.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12;

    document.getElementById('returnTimeText').textContent = `${hours}:${mins} ${ampm}`;
    const modal = new bootstrap.Modal(document.getElementById('returnTimeModal'));
    modal.show();
}

// â±ï¸ Contador de duraciÃ³n
function updateDurationCounter() {
    const currentSession = {% if current_session %}{
        startTime: new Date('{{ current_session.start_time|date:"c" }}')
    }{% else %}null{% endif %};

    if (!currentSession) return;

    function update() {
        const now = new Date();
        const diffMs = now - currentSession.startTime;
        const diffSeconds = Math.floor(diffMs / 1000);
        const hours = Math.floor(diffSeconds / 3600);
        const minutes = Math.floor((diffSeconds % 3600) / 60);
        const seconds = diffSeconds % 60;

        const durationText =
            hours > 0
                ? `${hours}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`
                : `${minutes.toString().padStart(2,'0')}m ${seconds.toString().padStart(2,'0')}s`;

        const counterEl = document.getElementById('duration-counter');
        if (counterEl) counterEl.textContent = durationText;
    }

    update();
    setInterval(update, 1000);
}

document.addEventListener('DOMContentLoaded', updateDurationCounter);
</script>

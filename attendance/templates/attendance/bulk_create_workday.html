{% extends "base.html" %}
{% load static %}

{% block title %}Bulk Create Work Days{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0">Bulk Create Work Days</h2>
                </div>
                
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="POST" id="bulkCreateForm">
                        {% csrf_token %}
                        
                        <!-- Date and Time Section -->
                        <div class="mb-5">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-calendar-date me-2"></i>Work Day Details
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">
                                        Work Date *
                                    </label>
                                    <input 
                                        type="date" 
                                        name="work_date" 
                                        class="form-control"
                                        max="{{ today|date:'Y-m-d' }}"
                                        required
                                    >
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">
                                        Check-In Time *
                                    </label>
                                    <input 
                                        type="time" 
                                        name="check_in_time" 
                                        class="form-control"
                                        value="09:00"
                                        required
                                    >
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">
                                        Check-Out Time *
                                    </label>
                                    <input 
                                        type="time" 
                                        name="check_out_time" 
                                        class="form-control"
                                        value="18:00"
                                        required
                                    >
                                </div>
                            </div>
                        </div>
                        
                        <!-- Break Sessions -->
                        <div class="mb-5">
                            <h5 class="text-primary mb-3">
                                Break Sessions
                            </h5>
                            <div id="breakSessions" class="mb-3"></div>
                            <button 
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                                hx-get="{% url 'add_break_session' %}"
                                hx-target="#breakSessions"
                                hx-swap="beforeend"
                                hx-vals='js:{index: document.querySelectorAll("#breakSessions .session-row").length}'
                            >
                                <i class="bi bi-plus-circle me-1"></i>Add Break
                            </button>
                        </div>
                        
                        <!-- Lunch Sessions -->
                        <div class="mb-5">
                            <h5 class="text-primary mb-3">
                                Lunch Sessions
                            </h5>
                            <div id="lunchSessions" class="mb-3"></div>
                            <button 
                                type="button"
                                class="btn btn-outline-primary btn-sm"
                                hx-get="{% url 'add_lunch_session' %}"
                                hx-target="#lunchSessions"
                                hx-swap="beforeend"
                                hx-vals='js:{index: document.querySelectorAll("#lunchSessions .session-row").length}'
                            >
                                <i class="bi bi-plus-circle me-1"></i>Add Lunch
                            </button>
                        </div>
                        
                        <!-- Reason -->
                        <div class="mb-5">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-chat-text me-2"></i>Reason
                            </h5>
                            <textarea 
                                name="reason" 
                                rows="3" 
                                class="form-control"
                                placeholder="e.g., System issue, Forgot to check in, Training session..."
                                required
                            ></textarea>
                        </div>
                        
                        <!-- Employee Selection -->
                        <div class="mb-5">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-people me-2"></i>Select Employees
                            </h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        Filter by Campaign (optional)
                                    </label>
                                    <select 
                                        id="campaignFilter" 
                                        class="form-select"
                                        hx-get="{% url 'load_employees_dropdown' %}"
                                        hx-target="#employeesDropdown"
                                        hx-include="[name='campaign_id']"
                                        name="campaign_id"
                                    >
                                        <option value="">All Campaigns</option>
                                        {% for campaign in campaigns %}
                                            <option value="{{ campaign.id }}">{{ campaign.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div id="employeesDropdown">
                                <label class="form-label fw-semibold">
                                    Select Employees *
                                </label>
                                <select 
                                    name="employees" 
                                    multiple 
                                    class="form-select"
                                    size="8"
                                    required
                                >
                                    <option value="" disabled>Select a campaign first or choose from all employees</option>
                                </select>
                                <div class="form-text mt-2">
                                    <span id="employeeCount">0</span> employee(s) selected
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle me-2"></i>Create Work Days
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Templates para las sesiones -->
<template id="breakSessionTemplate">
    <div class="session-row row g-3 align-items-center mb-3 p-3 bg-light rounded">
        <div class="col-md-4">
            <label class="form-label small">Start Time *</label>
            <input 
                type="time" 
                name="break_{{ index }}_start" 
                class="form-control form-control-sm"
                required
            >
        </div>
        <div class="col-md-4">
            <label class="form-label small">End Time *</label>
            <input 
                type="time" 
                name="break_{{ index }}_end" 
                class="form-control form-control-sm"
                required
            >
        </div>
        <div class="col-md-4">
            <button 
                type="button" 
                onclick="this.closest('.session-row').remove(); updateEmployeeCount();" 
                class="btn btn-outline-danger btn-sm"
            >
                <i class="bi bi-trash me-1"></i>Remove
            </button>
        </div>
    </div>
</template>

<template id="lunchSessionTemplate">
    <div class="session-row row g-3 align-items-center mb-3 p-3 bg-light rounded">
        <div class="col-md-4">
            <label class="form-label small">Start Time *</label>
            <input 
                type="time" 
                name="lunch_{{ index }}_start" 
                class="form-control form-control-sm"
                required
            >
        </div>
        <div class="col-md-4">
            <label class="form-label small">End Time *</label>
            <input 
                type="time" 
                name="lunch_{{ index }}_end" 
                class="form-control form-control-sm"
                required
            >
        </div>
        <div class="col-md-4">
            <button 
                type="button" 
                onclick="this.closest('.session-row').remove(); updateEmployeeCount();" 
                class="btn btn-outline-danger btn-sm"
            >
                <i class="bi bi-trash me-1"></i>Remove
            </button>
        </div>
    </div>
</template>

<script>
    // Auto-load all employees on page load
    document.addEventListener('DOMContentLoaded', function() {
        htmx.trigger('#campaignFilter', 'change');
        
        // Actualizar contador de empleados
        document.querySelector('select[name="employees"]')?.addEventListener('change', updateEmployeeCount);
    });
    
    // Actualizar contador de empleados seleccionados
    function updateEmployeeCount() {
        const select = document.querySelector('select[name="employees"]');
        if (select) {
            const selected = Array.from(select.selectedOptions).filter(opt => opt.value);
            document.getElementById('employeeCount').textContent = selected.length;
        }
    }
    
    // Form validation
    document.getElementById('bulkCreateForm')?.addEventListener('submit', function(e) {
        const select = document.querySelector('select[name="employees"]');
        const selected = select ? Array.from(select.selectedOptions).filter(opt => opt.value) : [];
        
        if (selected.length === 0) {
            e.preventDefault();
            showAlert('Please select at least one employee', 'warning');
            return false;
        }
        
        const confirmMessage = `Create work days for ${selected.length} employee(s)?`;
        if (!confirm(confirmMessage)) {
            e.preventDefault();
            return false;
        }
        
        return true;
    });
    
    // Funci√≥n para mostrar alertas
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const cardBody = document.querySelector('.card-body');
        cardBody.insertBefore(alertDiv, cardBody.firstChild);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
        }, 5000);
    }
    
    // Inicializar tooltips de Bootstrap
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}
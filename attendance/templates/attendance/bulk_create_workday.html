{% extends "base.html" %}
{% load static %}

{% block title %}Bulk Create Work Days{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h4 mb-0">
                        <i class="bi bi-calendar-plus me-2"></i>
                        Bulk Create Work Days
                    </h2>
                </div>
                
                <div class="card-body">
                    <!-- Info Alert -->
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> This creates simple work days with continuous work sessions.
                        Break and lunch times are NOT included - only total work time is recorded.
                        Use this for system issues or forgotten check-ins.
                    </div>
                    
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="POST" id="bulkCreateForm">
                        {% csrf_token %}
                        
                        <!-- Date and Time Section -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-calendar-date me-2"></i>Work Day Details
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">
                                        Work Date *
                                    </label>
                                    <input 
                                        type="date" 
                                        name="work_date" 
                                        class="form-control"
                                        max="{{ today|date:'Y-m-d' }}"
                                        required
                                    >
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">
                                        Check-In Time *
                                    </label>
                                    <input 
                                        type="time" 
                                        name="check_in_time" 
                                        class="form-control"
                                        value="09:00"
                                        required
                                    >
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">
                                        Check-Out Time *
                                    </label>
                                    <input 
                                        type="time" 
                                        name="check_out_time" 
                                        class="form-control"
                                        value="18:00"
                                        required
                                    >
                                </div>
                            </div>
                            <div class="form-text mt-2">
                                <i class="bi bi-clock me-1"></i>
                                Total work time will be calculated from check-in to check-out.
                                Breaks and lunch are NOT included.
                            </div>
                        </div>
                        
                        <!-- Reason -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-chat-text me-2"></i>Reason *
                            </h5>
                            <textarea 
                                name="reason" 
                                rows="3" 
                                class="form-control"
                                placeholder="e.g., System outage - employees worked but couldn't log in&#10;Forgot to check in - confirmed worked full shift&#10;Training session - no break logging available"
                                required
                            ></textarea>
                            <div class="form-text">
                                This reason will be permanently attached to the work day for audit purposes.
                            </div>
                        </div>
                        
                        <!-- Employee Selection -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="bi bi-people me-2"></i>Select Employees
                            </h5>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        Filter by Campaign (optional)
                                    </label>
                                    <select 
                                        id="campaignFilter" 
                                        class="form-select"
                                        hx-get="{% url 'load_employees_dropdown' %}"
                                        hx-target="#employeesDropdown"
                                        hx-include="[name='campaign_id']"
                                        name="campaign_id"
                                    >
                                        <option value="">All Campaigns</option>
                                        {% for campaign in campaigns %}
                                            <option value="{{ campaign.id }}">{{ campaign.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div id="employeesDropdown">
                                <label class="form-label fw-semibold">
                                    Select Employees *
                                </label>
                                <select 
                                    name="employees" 
                                    multiple 
                                    class="form-select"
                                    size="10"
                                    required
                                    onchange="updateEmployeeCount()"
                                >
                                    <option value="" disabled>Loading employees...</option>
                                </select>
                                <div class="form-text mt-2">
                                    <i class="bi bi-hand-index me-1"></i>
                                    Hold <kbd>Ctrl</kbd> (Windows) or <kbd>Cmd</kbd> (Mac) to select multiple employees.
                                    <span id="employeeCount" class="badge bg-primary ms-2">0 selected</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle me-2"></i>
                                Create Work Days
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="card mt-4 border-info">
                <div class="card-body">
                    <h6 class="card-title text-info">
                        <i class="bi bi-question-circle me-2"></i>
                        When to use this feature?
                    </h6>
                    <ul class="mb-0">
                        <li><strong>System Issues:</strong> Server was down, employees couldn't log in</li>
                        <li><strong>Forgotten Check-ins:</strong> Employee forgot to check in but did work</li>
                        <li><strong>Special Events:</strong> Training, meetings, or events without normal tracking</li>
                        <li><strong>Manual Corrections:</strong> Fixing historical data</li>
                    </ul>
                    <hr>
                    <p class="text-muted small mb-0">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Important:</strong> Created work days will have ONE continuous work session.
                        Breaks and lunch are not logged. For payroll purposes.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Auto-load employees on page load
    document.addEventListener('DOMContentLoaded', function() {
        htmx.trigger('#campaignFilter', 'change');
    });
    
    // Update employee count
    function updateEmployeeCount() {
        const select = document.querySelector('select[name="employees"]');
        if (select) {
            const selected = Array.from(select.selectedOptions).filter(opt => opt.value);
            document.getElementById('employeeCount').textContent = `${selected.length} selected`;
        }
    }
    
    // Form validation
    document.getElementById('bulkCreateForm')?.addEventListener('submit', function(e) {
        const select = document.querySelector('select[name="employees"]');
        const selected = select ? Array.from(select.selectedOptions).filter(opt => opt.value) : [];
        
        if (selected.length === 0) {
            e.preventDefault();
            alert('Please select at least one employee');
            return false;
        }
        
        // Calculate hours
        const checkIn = document.querySelector('[name="check_in_time"]').value;
        const checkOut = document.querySelector('[name="check_out_time"]').value;
        
        if (checkIn && checkOut) {
            const [inH, inM] = checkIn.split(':').map(Number);
            const [outH, outM] = checkOut.split(':').map(Number);
            
            let hours = outH - inH;
            let minutes = outM - inM;
            
            if (hours < 0) hours += 24; // Handle midnight crossover
            if (minutes < 0) {
                hours -= 1;
                minutes += 60;
            }
            
            const totalHours = hours + (minutes / 60);
            
            const confirmMsg = `Create work days for ${selected.length} employee(s)?

Total work time: ${totalHours.toFixed(1)} hours
(No breaks/lunch included)

Continue?`;
            
            return confirm(confirmMsg);
        }
        
        return true;
    });
</script>
{% endblock %}
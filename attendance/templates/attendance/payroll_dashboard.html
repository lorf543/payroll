{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">Payroll Dashboard</h1>
                <p class="page-subtitle">Your work history and earnings overview</p>
            </div>
            <div class="col-auto">
                <div class="current-period-badge bg-primary text-white px-3 py-2 rounded">
                    <small class="d-block">Current Period</small>
                    <strong>{{ current_period.name }}</strong>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- EstadÃ­sticas del Mes -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-gradient-primary">
                    <h5 class="card-title mb-0">Current Month</h5>
                </div>
                <div class="card-body">
                    <div class="">
                        <div class="stat-item text-center p-3 my-2">
                            <div class="stat-value text-success">{{ month_stats.payable_hours|floatformat:1 }}h</div>
                            <div class="stat-label text-muted">Hours Worked</div>
                        </div>
                        <div class="stat-item text-center p-3 my-2">
                            <div class="stat-value text-primary">${{ month_stats.earnings|intcomma }}</div>
                            <div class="stat-label text-muted">Total Earned</div>
                        </div>
                        <div class="stat-item text-center p-3 my-2">
                            <div class="stat-value text-info">{{ month_stats.days_worked }}</div>
                            <div class="stat-label text-muted">Days Worked</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">Payment Method:</small>
                        <span class="badge {% if 'fixed' in month_stats.pay_method %}bg-warning text-dark{% else %}bg-info{% endif %} ms-2">
                            {% if month_stats.pay_method == 'fixed_custom' %}Fixed Custom
                            {% elif month_stats.pay_method == 'fixed_position' %}Fixed Position
                            {% elif month_stats.pay_method == 'fixed_default' %}Fixed Default
                            {% elif month_stats.pay_method == 'hourly_custom' %}Hourly Custom
                            {% else %}Hourly Position{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

<!-- Historial Reciente (7 dÃ­as) -->
<div class="col-lg-8 mb-4">
    <div class="card shadow-sm h-100">
        <div class="card-header">
            <h5 class="card-title mb-0">Recent Activity (7 Days)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>In/Out</th>
                            <th>Hours</th>
                            <th>Earnings</th>
                            <th>Status Changes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in recent_days %}
                        <tr class="{% if day.is_weekend %}table-light{% endif %}">
                            <td>
                                {{ day.date|date:"M d" }}
                                {% if day.is_weekend %}<span class="badge bg-light text-dark ms-1">Weekend</span>{% endif %}
                            </td>
                            <td>
                                {% if day.first_in and day.last_out %}
                                    <div class="d-flex flex-column small">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-success me-2">IN</span>
                                            <span>{{ day.first_in.start_time|date:"g:i A" }}</span>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-secondary me-2">OUT</span>
                                            <span>
                                                {% if day.last_out.end_time %}
                                                    {{ day.last_out.end_time|date:"g:i A" }}
                                                {% else %}
                                                    {{ day.last_out.start_time|date:"g:i A" }}
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                {% elif day.first_in %}
                                    <div class="d-flex flex-column small">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-success me-2">IN</span>
                                            <span>{{ day.first_in.start_time|date:"g:i A" }}</span>
                                        </div>
                                        <div class="text-muted small">Still working...</div>
                                    </div>
                                {% else %}
                                    <span class="text-muted">No activity</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="fw-medium">{{ day.payable_hours|floatformat:1 }}h</span>
                            </td>
                            <td>
                                <span class="text-success fw-medium">${{ day.earnings|intcomma }}</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ day.records_count }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-3">No activity recorded</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

              <a class="btn btn-info btn-sm" href="{% url 'employee_status_history' %}">Full History</a>

        </div>
    </div>
</div>
    </div>

    <!-- Historial de Pagos Quincenales -->
    {% comment %} <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">ðŸ’° Pay Period History</h5>
                    <p class="text-muted mb-0 small">Last 6 pay periods (every 15 days)</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for period in payroll_data %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="pay-period-card card border-0 h-100 {% if forloop.first %}border-primary{% endif %}">
                                <div class="card-header bg-light {% if forloop.first %}bg-primary text-white{% endif %}">
                                    <h6 class="mb-0">{{ period.start_date|date:"M d" }} - {{ period.end_date|date:"M d, Y" }}</h6>
                                    {% if forloop.first %}<small>Current</small>{% endif %}
                                </div>
                                <div class="card-body">
                                    <div class="period-stats">
                                        <div class="stat-row d-flex justify-content-between py-1">
                                            <span class="text-muted">Hours:</span>
                                            <strong>{{ period.payable_hours|floatformat:1 }}h</strong>
                                        </div>
                                        <div class="stat-row d-flex justify-content-between py-1">
                                            <span class="text-muted">Earnings:</span>
                                            <strong class="text-success">${{ period.earnings|floatformat:2 }}</strong>
                                        </div>
                                        <div class="stat-row d-flex justify-content-between py-1">
                                            <span class="text-muted">Days Worked:</span>
                                            <span>{{ period.days_worked }}</span>
                                        </div>
                                        <div class="stat-row d-flex justify-content-between py-1">
                                            <span class="text-muted">Breaks:</span>
                                            <span class="text-muted">{{ period.total_break|stringformat:".1f" }}</span>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted d-block">Rate:</small>
                                        <span class="badge {% if 'fixed' in period.pay_method %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                            {% if period.pay_method == 'fixed_custom' %}Fixed
                                            {% elif period.pay_method == 'hourly_custom' %}Custom Hourly
                                            {% else %}Standard{% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-clock-history display-4 d-block mb-2"></i>
                                <p>No payroll history available</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>  {% endcomment %}

    <!-- Resumen de MÃ©todos de Pago -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">Payment Settings</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="payment-info">
                                <h6>Current Configuration</h6>
                                <div class="info-list">
                                    <div class="info-item d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted">Payment Type:</span>
                                        <span class="fw-medium">
                                            {% if employee.fixed_rate %}Fixed Salary{% else %}Hourly Rate{% endif %}
                                        </span>
                                    </div>
                                    <div class="info-item d-flex justify-content-between py-2 border-bottom">
                                        <span class="text-muted">Base Rate:</span>
                                        <span class="fw-medium">
                                            {% if employee.fixed_rate %}
                                                {% if employee.custom_base_salary %}
                                                    ${{ employee.custom_base_salary|intcomma }}/month
                                                {% elif employee.position.base_salary %}
                                                    ${{ employee.position.base_salary|intcomma }}/month
                                                {% else %}
                                                    ${{ employee.position.hour_rate|intcomma }}/hour (default)
                                                {% endif %}
                                            {% else %}
                                                {% if employee.custom_base_salary %}
                                                    ${{ employee.custom_base_salary|intcomma }}/hour
                                                {% else %}
                                                    ${{ employee.position.hour_rate|intcomma }}/hour
                                                {% endif %}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="payment-tips">
                                <h6>Tips</h6>
                                <ul class="small text-muted">
                                    <li>Pay periods are calculated every 15 days</li>
                                    <li>Only "Ready" status counts toward payable hours</li>
                                    <li>Contact HR for payment method changes</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .page-header {
        background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    
    .page-title {
        color: white;
        margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }
    
    .stat-item {
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.03);
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.85rem;
    }
    
    .pay-period-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid var(--border-color);
    }
    
    .pay-period-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .period-stats .stat-row {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .period-stats .stat-row:last-child {
        border-bottom: none;
    }
    
    .current-period-badge {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        .stat-item {
            padding: 1rem !important;
        }
    }
</style>
{% endblock content %}
{% extends "base.html" %}
{% load static %}
{% load filters %}

{% block title %}Day Details - {{ work_day.date|date:"M d, Y" }} - {{ work_day.employee.user.get_full_name }}{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'supervisor_dashboard' %}">Supervisor Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'employee_attendance_detail' work_day.employee.id %}">{{ work_day.employee.user.get_full_name }}</a></li>
                        <li class="breadcrumb-item active">{{ work_day.date|date:"F d, Y" }}</li>
                    </ol>
                </nav>
                <div class="d-flex align-items-center">

                    <div>
                        <h1 class="page-title mb-1">{{ work_day.employee.user.get_full_name }}</h1>
                        <p class="page-subtitle mb-0">{{ work_day.date|date:"l, F d, Y" }} • {{ work_day.employee.position.title|default:"Employee" }}</p>
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    <a href="{% url 'employee_attendance_detail' work_day.employee.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left me-2"></i>Back
                    </a>
                    <a href="{% url 'supervisor_dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-speedometer2 me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-start border-primary border-4">
                <div class="card-body">
                    <div class="text-primary fs-2 fw-bold">
                        {{ total_work|format_timedelta }}h
                    </div>
                    <small class="text-muted">Total Time (Check-in → Check-out)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-start border-success border-4">
                <div class="card-body">
                    <div class="text-success fs-2 fw-bold">
                        {{payable_hours|format_timedelta }}h
                    </div>
                    <small class="text-muted">Payable Work Hours (excluding Break & Lunch)</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-start border-success border-4">
                <div class="card-body">
                    <div class="text-success fs-2 fw-bold">
                        {{total_break|format_timedelta}}
                    </div>
                    <small class="text-muted">Total break time</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-start border-success border-4">
                <div class="card-body">
                    <div class="text-success fs-2 fw-bold">
                        {{total_lunch|format_timedelta }}
                    </div>
                    <small class="text-muted">Total break time</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Timeline -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">
            <i class="bi bi-clock-history me-2"></i>Activity Timeline
        </h5>
    </div>
    <div class="card-body">
        {% if sessions %}
        <div class="timeline">
            {% for session in sessions %}
            <div class="timeline-item {% if not session.end_time %}current-session{% endif %}">
                <div class="timeline-marker 
                    {% if session.session_type == 'work' %}bg-success
                    {% elif session.session_type == 'break' %}bg-warning
                    {% elif session.session_type == 'lunch' %}bg-info
                    {% elif session.session_type == 'training' %}bg-primary
                    {% elif session.session_type == 'meeting' %}bg-danger
                    {% else %}bg-secondary{% endif %}">
                </div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">
                            <span class="badge status-{{ session.session_type }}">
                                {{ session.get_session_type_display }}
                            </span>
                        </h6>
                        <small class="text-muted">
                            {{ session.start_time|date:"g:i A" }}
                            {% if session.end_time %}
                                - {{ session.end_time|date:"g:i A" }}
                            {% else %}
                                - Present
                            {% endif %}
                        </small>
                    </div>

                    {% if session.end_time %}
                        <small class="text-muted d-block mb-2">
                            <i class="bi bi-clock me-1"></i>Duration: {{ session.formatted_duration }}
                        </small>
                    {% else %}
                        <small class="text-muted d-block mb-2">
                            <i class="bi bi-hourglass-split me-1"></i>Active
                        </small>
                    {% endif %}

                    {% if session.campaign %}
                        <div>
                            <small class="text-muted">
                                <i class="bi bi-megaphone me-1"></i>{{ session.campaign.name }}
                            </small>
                        </div>
                    {% endif %}

                    {% if session.notes %}
                        <div class="mt-2 p-2 bg-light rounded">
                            <small class="text-muted">
                                <i class="bi bi-chat-left-text me-1"></i>{{ session.notes }}
                            </small>
                        </div>
                    {% endif %}


                    <div class="mt-3">
                        <a href="{% url 'edit_session' session.id %}" 
                           class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-pencil"></i> Edit Session
                        </a>
                        
                        {% if request.user.is_superuser %}
                        <a href="{% url 'delete_session' session.id %}" 
                           class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-pencil"></i> Delete Session
                        </a>
                        {% endif %}
                            
                    </div>

                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="bi bi-clock-history display-4 text-muted d-block mb-3"></i>
            <p class="text-muted">No activity recorded for this day.</p>
        </div>
        {% endif %}
    </div>
</div>

    <!-- Day & Employee Information -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0"><i class="bi bi-calendar-check me-2"></i>Day Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Date</dt>
                        <dd class="col-sm-8">{{ work_day.date|date:"F d, Y" }}</dd>

                        <dt class="col-sm-4">Status</dt>
                        <dd class="col-sm-8">
                            <span class="badge {% if work_day.status == 'completed' %}bg-success{% elif work_day.status == 'active' %}bg-warning{% else %}bg-secondary{% endif %}">
                                {{ work_day.get_status_display }}
                            </span>
                        </dd>

                        {% if work_day.check_in %}
                        <dt class="col-sm-4">Check In</dt>
                        <dd class="col-sm-8">{{ work_day.check_in|date:"g:i A" }}</dd>
                        {% endif %}
                        {% if work_day.check_out %}
                        <dt class="col-sm-4">Check Out</dt>
                        <dd class="col-sm-8">{{ work_day.check_out|date:"g:i A" }}</dd>
                        {% endif %}

                        <dt class="col-sm-4">Break Count</dt>
                        <dd class="col-sm-8">{{ work_day.break_count }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0"><i class="bi bi-person-badge me-2"></i>Employee Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        
                        <dt class="col-sm-4">Name</dt>
                        <dd class="col-sm-8">{{ work_day.employee.user.get_full_name }}</dd>

                        <dt class="col-sm-4">Employee Code</dt>
                        <dd class="col-sm-8">{{ work_day.employee.employee_code }}</dd>

                        <dt class="col-sm-4">Position</dt>
                        <dd class="col-sm-8">{{ work_day.employee.position.title|default:"Not assigned" }}</dd>

                        <dt class="col-sm-4">Department</dt>
                        <dd class="col-sm-8">{{ work_day.employee.department.name|default:"Not assigned" }}</dd>

                        <dt class="col-sm-4">Campaign</dt>
                        <dd class="col-sm-8">{{ work_day.employee.current_campaign.name|default:"No campaign" }}</dd>

                        <dt class="col-sm-4">Supervisor</dt>
                        <dd class="col-sm-8">
                            {% if work_day.employee.supervisor %}
                                {{ work_day.employee.supervisor.user.get_full_name }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-lg {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}
.timeline {
    position: relative;
    padding-left: 30px;
}
.timeline-item {
    position: relative;
    padding: 20px 0;
    border-left: 2px solid #e9ecef;
}
.timeline-marker {
    position: absolute;
    left: -31px;
    top: 25px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 0 2px;
}
.timeline-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.current-session .timeline-content {
    background: #f8f9fa;
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}
.status-work { background-color: #28a745; color: white; }
.status-break { background-color: #ffc107; color: black; }
.status-lunch { background-color: #6c757d; color: white; }
.status-training { background-color: #007bff; color: white; }
.status-meeting { background-color: #dc3545; color: white; }
.status-technical { background-color: #fd7e14; color: white; }
.card { border: none; border-radius: 12px; }
.border-start { border-left-width: 4px !important; }
</style>
{% endblock %}

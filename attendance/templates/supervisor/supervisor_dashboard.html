{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Supervisor Dashboard - Team Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Supervisor Dashboard

                </h1>
                <p class="page-subtitle">Real-time team monitoring and management</p>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    <a href="{% url 'team_attendance_history' %}" class="btn btn-outline-primary">
                        <i class="bi bi-clock-history me-2"></i>
                        Team History
                    </a>
                    <a href="{% url 'employee_profile' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-person me-2"></i>
                        My Profile
                    </a>

                </div>
            </div>
        </div>
    </div>

    <!-- Team Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-primary text-uppercase small fw-bold">Team Size</div>
                            <div class="number display-6 fw-bold text-primary">{{ total_team_members }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people text-primary fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-success text-uppercase small fw-bold">Logged In</div>
                            <div class="number display-6 fw-bold text-success">{{ logged_in_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-person-check text-success fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-info text-uppercase small fw-bold">In Campaign</div>
                            <div class="number display-6 fw-bold text-info">{{ active_in_campaign }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-megaphone text-info fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-warning text-uppercase small fw-bold">Today</div>
                            <div class="number display-6 fw-bold text-warning">{{ today|date:"M d" }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-calendar-check text-warning fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Status Grid -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-person-lines-fill me-2"></i>
                Team Status
            </h5>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">Online</span>
                <span class="badge bg-secondary me-2">Offline</span>
                <span class="badge bg-warning me-2">Break</span>
                <button id="refresh-btn" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Employee</th>
                            <th>Department</th>
                            <th>Campaign</th>
                            <th>Status</th>
                            <th>Work Time</th>
                            <th>Login</th>
                            {% comment %} <th>Actions</th> {% endcomment %}
                        </tr>
                    </thead>
                    <tbody id="team-status-body">
                        {% for data in team_data %}
                        <tr>
                            <td>
                                <a href="{% url 'employee_attendance_detail' data.employee.id %}">
                                    <strong>{{ data.employee.full_name }}</strong>
                                </a>
                                <br>
                                <small class="text-muted">{{ data.employee.position }}</small>
                            </td>
                            <td>{{ data.employee.department.name }}</td>
                            <td>
                                {% if data.employee.current_campaign %}
                                    {{ data.employee.current_campaign.name }}
                                {% else %}
                                    <span class="text-muted">â€”</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if data.current_status %}
                                    <span class="badge status-{{ data.current_status.status }}">
                                        {{ data }}
                                    </span><br>
                                    <small class="text-muted">
                                        Since {{ data.current_status.start_time|date:"g:i A" }}
                                    </small>
                                {% else %}
                                    <span class="text-muted">No status</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if data.current_session and data.current_session.start_time %}
                                    <span class="live-counter"
                                          data-employee="{{ data.employee.id }}"
                                          data-start="{{ data.current_session.start_time|date:'c' }}">
                                          00:00:00
                                    </span>
                                {% else %}
                                    <span class="text-muted">No active session</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if data.employee.user.last_login %}
                                    {{ data.employee.user.last_login|date:"M j, g:i A" }}
                                {% else %}
                                    <span class="text-muted">â€”</span>
                                {% endif %}
                            </td>
                            {% comment %} <td>
                                <button 
                                class="btn btn-outline-danger btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#forceLogoutModal"
                                data-employee-id="{{ employee.id }}"
                                data-employee-name="{{ employee.user.username }}"
                                >
                                <i class="bi bi-power"></i> Logout
                                </button>
                            </td> {% endcomment %}
                        </tr>   
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">No employees found in your team.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'team_attendance_history' %}" class="btn btn-outline-primary text-start">
                            <i class="bi bi-clock-history me-2"></i>View Team Attendance History
                        </a>
                        <a href="{% url 'export_team_report_excel' %}" class="btn btn-outline-success text-start" data-bs-toggle="modal" data-bs-target="#teamReportModal">
                            <i class="bi bi-file-earmark-text me-2"></i>Generate Team Report
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Team Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Total Team Members</span>
                            <span class="badge bg-primary rounded-pill">{{ total_team_members }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Currently Online</span>
                            <span class="badge bg-success rounded-pill">{{ logged_in_count }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Active in Campaigns</span>
                            <span class="badge bg-info rounded-pill">{{ active_in_campaign }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Available for Assignment</span>
                            <span class="badge bg-warning rounded-pill">{{ total_team_members|add:"-active_in_campaign" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- ðŸ”’ Modal de ConfirmaciÃ³n -->
<div class="modal fade" id="forceLogoutModal" tabindex="-1" aria-labelledby="forceLogoutLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="forceLogoutLabel">
          <i class="bi bi-exclamation-triangle"></i> Confirmar Cierre de SesiÃ³n
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">
          Â¿EstÃ¡s seguro de que deseas forzar el cierre de sesiÃ³n de 
          <strong id="employeeName"></strong>?
        </p>
        <small class="text-muted">Esto cerrarÃ¡ todas sus sesiones activas y finalizarÃ¡ su jornada actual.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <form id="forceLogoutForm" method="POST" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-power"></i> Forzar Logout
          </button>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Team Report Modal -->
<div class="modal fade" id="teamReportModal" tabindex="-1" aria-labelledby="teamReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamReportModalLabel">
                    <i class="bi bi-file-earmark-excel me-2"></i>
                    Generate Team Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="teamReportForm" action="{% url 'export_team_report_excel' %}" method="GET">
                <div class="modal-body">
                    <p class="text-muted mb-4">
                        Generate an Excel report with detailed attendance information for your team members.
                        The report will include work sessions, breaks, and lunch times for the selected period.
                    </p>
                    
                    <div class="row g-3">
                        <!-- Date Range -->
                        <div class="col-md-6">
                            <label for="date_from" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" required>
                        </div>
                        <div class="col-md-6">
                            <label for="date_to" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" required>
                        </div>
                    
                    </div>
                    
                    <!-- Preview Info -->
                    <div class="alert alert-info mt-4">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-info-circle fs-5"></i>
                            </div>
                            <div>
                                <h6 class="alert-heading mb-2">Report Information</h6>
                                <p class="mb-1">â€¢ Each row represents one employee per date</p>
                                <p class="mb-1">â€¢ Includes up to 2 breaks and 1 lunch with start/end times</p>
                                <p class="mb-0">â€¢ Shows total work time and session count</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-file-earmark-excel me-2"></i>
                        Generate Excel Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Live Timer Script -->
<script>


document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("forceLogoutModal");
    const form = document.getElementById("forceLogoutForm");
    const namePlaceholder = document.getElementById("employeeName");

    modal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const employeeId = button.getAttribute("data-employee-id");
        const employeeName = button.getAttribute("data-employee-name");

        // Actualiza el texto del modal
        namePlaceholder.textContent = employeeName;

        // Actualiza la acciÃ³n del formulario dinÃ¡micamente
        form.action = `/force-logout/${employeeId}/`;
    });
});


    document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('teamReportForm');
    const dateFrom = document.getElementById('date_from');
    const dateTo = document.getElementById('date_to');
    
    // Establecer fecha por defecto (Ãºltimos 7 dÃ­as)
    const today = new Date();
    const oneWeekAgo = new Date(today);
    oneWeekAgo.setDate(today.getDate() - 7);
    
    dateTo.valueAsDate = today;
    dateFrom.valueAsDate = oneWeekAgo;
    
    form.addEventListener('submit', function(e) {
        if (!dateFrom.value || !dateTo.value) {
            e.preventDefault();
            alert('Please select both start and end dates.');
            return;
        }
        
        const fromDate = new Date(dateFrom.value);
        const toDate = new Date(dateTo.value);
        
        if (fromDate > toDate) {
            e.preventDefault();
            alert('Start date cannot be after end date.');
            return;
        }
        
        // Opcional: Limitar el rango de fechas (mÃ¡ximo 3 meses)
        const maxRange = 90; // dÃ­as
        const diffTime = Math.abs(toDate - fromDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays > maxRange) {
            e.preventDefault();
            alert(`Date range cannot exceed ${maxRange} days. Please select a smaller range.`);
            return;
        }
    });
});
document.addEventListener('DOMContentLoaded', () => {
    const counters = new Map();

    function updateCounters() {
        counters.forEach((data, id) => {
            if (!data.active) return;
            const now = new Date();
            let diff = Math.floor((now - data.startTime) / 1000);
            if (diff < 0) diff = 0;
            const hours = Math.floor(diff / 3600);
            diff %= 3600;
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            data.element.textContent =
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        });
    }

    function initializeCounters() {
        document.querySelectorAll('.live-counter').forEach(span => {
            const id = span.dataset.employee;
            const startTime = new Date(span.dataset.start);
            counters.set(id, { element: span, startTime, active: true });
        });
    }

    function resetInactiveCounters() {
        counters.forEach((data, id) => {
            if (!document.querySelector(`.live-counter[data-employee="${id}"]`)) {
                data.active = false;
                data.element.classList.add('text-muted');
            }
        });
    }

    initializeCounters();
    setInterval(updateCounters, 1000);

    // ðŸ” Auto-refresh
    function refreshTeamStatus() {
        fetch(window.location.href)
            .then(res => res.text())
            .then(html => {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const newBody = doc.getElementById('team-status-body');
                if (newBody) {
                    document.getElementById('team-status-body').innerHTML = newBody.innerHTML;
                    initializeCounters();
                    resetInactiveCounters();
                }
            })
            .catch(err => console.error('Error refreshing team status:', err));
    }

    document.getElementById('refresh-btn').addEventListener('click', refreshTeamStatus);
    //setInterval(refreshTeamStatus, 5000);
});
</script>
{% endblock %}

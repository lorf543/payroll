{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Revisar Período - {{ period.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">
                    <i class="bi bi-clipboard-check me-2"></i>
                    {{ period.name }}
                </h1>
                <p class="page-subtitle">
                    {{ period.start_date }} al {{ period.end_date }} • Pago: {{ period.pay_date }}
                </p>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    {% if stats.all_approved %}
                    <button class="btn btn-success" onclick="generatePayroll()">
                        <i class="bi bi-calculator me-2"></i>
                        Generar Nómina
                    </button>
                    {% else %}
                    <button class="btn btn-warning" onclick="approveAll()">
                        <i class="bi bi-check-all me-2"></i>
                        Aprobar Todo
                    </button>
                    {% endif %}
                    <a href="{% url 'nomina:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>
                        Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas del Período -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-start border-primary border-4">
                <div class="card-body text-center">
                    <div class="text-primary text-uppercase small fw-bold">Empleados</div>
                    <div class="number text-primary">{{ stats.total_employees }}</div>
                    <small class="text-muted">{{ stats.employees_with_workdays }} con días</small>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-start border-info border-4">
                <div class="card-body text-center">
                    <div class="text-info text-uppercase small fw-bold">Días Trabajados</div>
                    <div class="number text-info">{{ stats.total_workdays }}</div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-start border-success border-4">
                <div class="card-body text-center">
                    <div class="text-success text-uppercase small fw-bold">Días Aprobados</div>
                    <div class="number text-success">{{ stats.approved_workdays }}</div>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-success" 
                             style="width: {% widthratio stats.approved_workdays stats.total_workdays 100 %}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-warning border-4">
                <div class="card-body text-center">
                    <div class="text-warning text-uppercase small fw-bold">Total Bruto</div>
                    <div class="number text-warning">${{ stats.total_gross|floatformat:2|intcomma }}</div>
                    <small class="text-muted">Salarios brutos</small>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-danger border-4">
                <div class="card-body text-center">
                    <div class="text-danger text-uppercase small fw-bold">Total Neto</div>
                    <div class="number text-danger">${{ stats.total_net|floatformat:2|intcomma }}</div>
                    <small class="text-muted">Después de deducciones</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado de Aprobación -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-check-circle me-2"></i>
                Estado de Aprobación
            </h5>
            {% if not stats.all_approved %}
            <span class="badge bg-warning">
                {{ stats.total_workdays|add:"-stats.approved_workdays" }} días pendientes
            </span>
            {% else %}
            <span class="badge bg-success">
                <i class="bi bi-check-lg me-1"></i>Todo Aprobado
            </span>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" 
                     style="width: {% widthratio stats.approved_workdays stats.total_workdays 100 %}%">
                    {{ stats.approved_workdays }} aprobados
                </div>
                <div class="progress-bar bg-warning" 
                     style="width: {% widthratio stats.total_workdays|add:"-stats.approved_workdays" stats.total_workdays 100 %}%">
                    {{ stats.total_workdays|add:"-stats.approved_workdays" }} pendientes
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Empleados -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-people me-2"></i>
                Empleados del Período
            </h5>
        </div>
        <div class="card-body p-0">
            {% for employee_data in employees_data %}
            <div class="employee-card card mb-3 mx-3 mt-3 {% if employee_data.fully_approved %}approved{% else %}pending{% endif %}">
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- Información del Empleado -->
                        <div class="col-md-3">
                            <h6 class="mb-1">{{ employee_data.employee.full_name }}</h6>
                            <small class="text-muted">
                                {{ employee_data.employee.position.name|default:"Sin puesto" }} • 
                                {{ employee_data.employee.department.name|default:"Sin departamento" }}
                            </small>
                        </div>

                        <!-- Estadísticas -->
                        <div class="col-md-2">
                            <div class="text-center">
                                <strong class="d-block">{{ employee_data.workdays_count }}</strong>
                                <small class="text-muted">Días</small>
                            </div>
                        </div>

                        <!-- Estado -->
                        <div class="col-md-2">
                            {% if employee_data.fully_approved %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-lg me-1"></i>Completado
                            </span>
                            {% else %}
                            <span class="badge bg-warning">
                                {{ employee_data.workdays_count|add:"-employee_data.approved_count" }} pendientes
                            </span>
                            {% endif %}
                        </div>

                        <!-- Totales -->
                        <div class="col-md-3">
                            <div class="text-end">
                                <strong class="d-block text-success">
                                    ${{ employee_data.total_gross|floatformat:2|intcomma }}
                                </strong>
                                <small class="text-muted">Bruto</small>
                                <br>
                                <strong class="d-block text-primary">
                                    ${{ employee_data.total_net|floatformat:2|intcomma }}
                                </strong>
                                <small class="text-muted">Neto</small>
                            </div>
                        </div>

                        <!-- Acciones -->
                        <div class="col-md-2">
                            <div class="d-grid gap-2">
                                {% if not employee_data.fully_approved and employee_data.has_workdays %}
                                <button class="btn btn-sm btn-outline-warning" 
                                        onclick="approveEmployee({{ employee_data.employee.id }})">
                                    <i class="bi bi-check"></i> Aprobar
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="viewDetails({{ employee_data.employee.id }})">
                                    <i class="bi bi-eye"></i> Detalles
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Días Trabajados (Expandible) -->
                    <div class="row mt-3" id="details-{{ employee_data.employee.id }}" style="display: none;">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Días Trabajados</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Horas</th>
                                            <th>Regular</th>
                                            <th>Extra</th>
                                            <th>Total</th>
                                            <th>Estado</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for workday in employee_data.workdays %}
                                        <tr>
                                            <td>{{ workday.date }}</td>
                                            <td>{{ workday.productive_hours|floatformat:2 }}h</td>
                                            <td>${{ workday.regular_pay|floatformat:2 }}</td>
                                            <td>${{ workday.overtime_pay|floatformat:2 }}</td>
                                            <td><strong>${{ workday.total_pay|floatformat:2 }}</strong></td>
                                            <td>
                                                {% if workday.is_approved %}
                                                <span class="badge bg-success">Aprobado</span>
                                                {% else %}
                                                <span class="badge bg-warning">Pendiente</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm {% if workday.is_approved %}btn-outline-warning{% else %}btn-outline-success{% endif %}"
                                                        onclick="toggleWorkday({{ workday.id }})">
                                                    {% if workday.is_approved %}
                                                    <i class="bi bi-x"></i> Desaprobar
                                                    {% else %}
                                                    <i class="bi bi-check"></i> Aprobar
                                                    {% endif %}
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                No hay días trabajados en este período
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-people display-4 d-block mb-2"></i>
                No hay empleados activos
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function generatePayroll() {
    if (confirm('¿Estás seguro de que quieres generar la nómina para este período? Esto creará los pagos para todos los empleados.')) {
        window.location.href = "{% url 'nomina:generate_payroll' period.id %}";
    }
}

function approveAll() {
    if (confirm('¿Estás seguro de que quieres aprobar todos los días trabajados pendientes?')) {
        window.location.href = "{% url 'nomina:approve_all' period.id %}";
    }
}

function approveEmployee(employeeId) {
    if (confirm('¿Aprobar todos los días de este empleado?')) {
        // Implementar aprobación por empleado
        alert('Funcionalidad en desarrollo: Aprobar empleado ' + employeeId);
    }
}

function viewDetails(employeeId) {
    const detailsDiv = document.getElementById('details-' + employeeId);
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}

function toggleWorkday(workdayId) {
    fetch("{% url 'nomina:toggle_approval' 0 %}".replace('0', workdayId) + '?period_id={{ period.id }}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Recargar para ver cambios
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar el día trabajado');
    });
}
</script>
{% endblock %}
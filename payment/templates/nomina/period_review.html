{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Review Period - {{ period.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">
                    <i class="bi bi-clipboard-check me-2"></i>
                    {{ period.name }}
                </h1>
                <p class="page-subtitle">
                    {{ period.start_date }} to {{ period.end_date }} â€¢ Payment: {{ period.pay_date }}
                    {% if period.period_type == 'first_half' %}
                    <span class="badge bg-info ms-2">First Half of Month</span>
                    {% elif period.period_type == 'second_half' %}
                    <span class="badge bg-warning ms-2">Second Half of Month</span>
                    {% endif %}
                </p>
            </div>
            <div class="col-auto">
                <div class="btn-group">
                    {% if stats.all_approved %}
                    <button class="btn btn-success" onclick="generatePayroll()">
                        <i class="bi bi-calculator me-2"></i>
                        Generate Payroll
                    </button>
                    {% if period.is_second_half %}
                    <a href="{% url 'nomina:recalculate_monthly_isr' period.id %}" class="btn btn-info" 
                       onclick="return confirm('Recalculate ISR for all employees based on monthly totals?')">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Recalculate ISR
                    </a>
                    {% endif %}
                    {% else %}
                    <button class="btn btn-warning" onclick="approveAll()">
                        <i class="bi bi-check-all me-2"></i>
                        Approve All
                    </button>
                    {% endif %}
                    <a href="{% url 'nomina:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>
                        Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Period Statistics -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-start border-primary border-4">
                <div class="card-body text-center">
                    <div class="text-primary text-uppercase small fw-bold">Employees</div>
                    <div class="number text-primary">{{ stats.total_employees }}</div>
                    <small class="text-muted">{{ stats.employees_with_workdays }} with days</small>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-warning border-4">
                <div class="card-body text-center">
                    <div class="text-warning text-uppercase small fw-bold">Gross Total</div>
                    <div class="number text-warning">${{ stats.total_gross|floatformat:2|intcomma }}</div>
                    <small class="text-muted">Gross salaries</small>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-danger border-4">
                <div class="card-body text-center">
                    <div class="text-danger text-uppercase small fw-bold">Net Total</div>
                    <div class="number text-danger">${{ stats.total_net|floatformat:2|intcomma }}</div>
                    <small class="text-muted">After deductions</small>
                </div>
            </div>
        </div>

        <!-- ISR Statistics -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-start border-info border-4">
                <div class="card-body text-center">
                    <div class="text-info text-uppercase small fw-bold">Total ISR</div>
                    <div class="number text-info">${{ stats.total_isr|floatformat:2|intcomma }}</div>
                    <small class="text-muted">
                        {% if period.is_first_half %}
                        First half (no ISR)
                        {% elif period.is_second_half %}
                        Second half ISR
                        {% else %}
                        Monthly ISR
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Monthly Accumulated -->
        {% if period.is_second_half %}
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-start border-success border-4">
                <div class="card-body text-center">
                    <div class="text-success text-uppercase small fw-bold">Monthly Gross</div>
                    <div class="number text-success">${{ stats.monthly_gross|floatformat:2|intcomma }}</div>
                    <small class="text-muted">Accumulated monthly</small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ISR Calculation Info Banner -->
    {% if period.is_second_half and first_half_period %}
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-3 fs-4"></i>
            <div>
                <h6 class="mb-1">ISR Calculation Information</h6>
                <p class="mb-0">
                    <strong>Second half period:</strong> ISR is calculated based on the <strong>monthly total</strong>.
                    This period includes salary from <strong>{{ first_half_period.start_date }} to {{ first_half_period.end_date }}</strong> 
                    (First half) plus this period. 
                    <a href="#" data-bs-toggle="modal" data-bs-target="#isrCalculationModal" class="text-decoration-none">
                        Learn more about ISR calculation
                    </a>
                </p>
            </div>
        </div>
    </div>
    {% elif period.is_first_half %}
    <div class="alert alert-warning mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
            <div>
                <h6 class="mb-1">First Half Period - No ISR Applied</h6>
                <p class="mb-0">
                    This is the first half of the month. No ISR will be applied in this period.
                    Salary will be accumulated and ISR will be calculated and applied in the second half.
                </p>
            </div>
        </div>
    </div>
    {% endif %}
      
    <!-- Employee List by Campaign -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-people me-2"></i>
                Period Employees by Campaign
            </h5>
        </div>
        <div class="card-body p-0">
            <!-- Campaign Tabs -->
            {% if grouped_employees %}
            <ul class="nav nav-tabs" id="campaignTabs" role="tablist">
                {% for campaign_name, employees in grouped_employees.items %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if forloop.first %}active{% endif %}" 
                            id="tab-{{ forloop.counter }}" 
                            data-bs-toggle="tab" 
                            data-bs-target="#campaign-{{ forloop.counter }}" 
                            type="button" 
                            role="tab" 
                            aria-controls="campaign-{{ forloop.counter }}" 
                            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                        {{ campaign_name }}
                        <span class="badge bg-secondary ms-1">{{ employees|length }}</span>
                    </button>
                </li>
                {% endfor %}
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content p-3" id="campaignTabsContent">
                {% for campaign_name, employees in grouped_employees.items %}
                <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                     id="campaign-{{ forloop.counter }}" 
                     role="tabpanel" 
                     aria-labelledby="tab-{{ forloop.counter }}">
                    
                    <!-- Campaign Statistics -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">{{ campaign_name }} - {{ employees|length }} employees</h6>
                                <div>
                                    {% with approved_count=employees|length %}
                                    {% with pending_count=employees|length %}
                                    <span class="badge bg-success me-2">
                                        Approved: <span id="approved-count-{{ forloop.counter }}">{{ employees|length }}</span>
                                    </span>
                                    <span class="badge bg-warning">
                                        Pending: <span id="pending-count-{{ forloop.counter }}">0</span>
                                    </span>
                                    {% endwith %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campaign Filter -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" 
                                       class="form-control campaign-filter" 
                                       data-campaign="{{ forloop.counter }}" 
                                       placeholder="Filter employees by name...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group float-end" role="group">
                                <input type="radio" 
                                       class="btn-check status-filter" 
                                       name="status-{{ forloop.counter }}" 
                                       id="all-{{ forloop.counter }}" 
                                       value="all" 
                                       autocomplete="off" 
                                       checked>
                                <label class="btn btn-outline-primary" for="all-{{ forloop.counter }}">
                                    All
                                </label>

                                <input type="radio" 
                                       class="btn-check status-filter" 
                                       name="status-{{ forloop.counter }}" 
                                       id="approved-{{ forloop.counter }}" 
                                       value="approved" 
                                       autocomplete="off">
                                <label class="btn btn-outline-success" for="approved-{{ forloop.counter }}">
                                    Approved
                                </label>

                                <input type="radio" 
                                       class="btn-check status-filter" 
                                       name="status-{{ forloop.counter }}" 
                                       id="pending-{{ forloop.counter }}" 
                                       value="pending" 
                                       autocomplete="off">
                                <label class="btn btn-outline-warning" for="pending-{{ forloop.counter }}">
                                    Pending
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employees in this campaign -->
                    {% for employee_data in employees %}
                    <div class="employee-card card mb-3 campaign-{{ forloop.parentloop.counter }} 
                                {% if employee_data.fully_approved %}approved{% else %}pending{% endif %}" 
                         data-status="{% if employee_data.fully_approved %}approved{% else %}pending{% endif %}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <!-- Employee Information -->
                                <div class="col-md-2">
                                    <h6 class="mb-1">
                                        {% if employee_data.employee.user %}
                                            {{ employee_data.employee.user.get_full_name|default:employee_data.employee.user.username }}
                                        {% else %}
                                            {{ employee_data.employee.employee_code|default:"Unknown Employee" }}
                                        {% endif %}
                                    </h6>
                                    <small class="text-muted">
                                        {{ employee_data.employee.position.name|default:"No position" }}
                                    </small>
                                </div>

                                <!-- Statistics -->
                                <div class="col-md-1">
                                    <div class="text-center">
                                        <strong class="d-block">{{ employee_data.workdays_count }}</strong>
                                        <small class="text-muted">Days</small>
                                    </div>
                                </div>

                                <!-- Status -->
                                <div class="col-md-1">
                                    {% if employee_data.fully_approved %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-lg me-1"></i>Completed
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning">
                                        {{ employee_data.workdays_count|add:"-employee_data.approved_count" }} pending
                                    </span>
                                    {% endif %}
                                </div>

                                <!-- Salary Information -->
                                <div class="col-md-3">
                                    <div class="text-end">
                                        <strong class="d-block text-success">
                                            ${{ employee_data.total_gross|floatformat:2|intcomma }}
                                        </strong>
                                        <small class="text-muted">This Period Gross</small>
                                        <br>
                                        <strong class="d-block text-primary">
                                            ${{ employee_data.total_net|floatformat:2|intcomma }}
                                        </strong>
                                        <small class="text-muted">Net Pay</small>
                                    </div>
                                </div>

                                <!-- ISR Information -->
                                <div class="col-md-3">
                                    <div class="text-end">
                                        {% if period.is_first_half %}
                                            <div class="text-info small">
                                                <i class="bi bi-info-circle me-1"></i>
                                                No ISR this period
                                            </div>
                                            <div class="text-muted small">
                                                Monthly: ${{ employee_data.monthly_gross|floatformat:2 }}
                                            </div>
                                            
                                        {% elif period.is_second_half %}
                                            <div class="d-flex justify-content-between small">
                                                <span class="text-muted">Monthly:</span>
                                                <span>${{ employee_data.monthly_gross|floatformat:2 }}</span>
                                            </div>
                                            <div class="d-flex justify-content-between small">
                                                <span class="text-muted">Monthly ISR:</span>
                                                <span class="text-danger">${{ employee_data.monthly_isr|floatformat:2 }}</span>
                                            </div>
                                            <div class="d-flex justify-content-between small">
                                                <span class="text-muted">This Period:</span>
                                                <strong class="text-danger">${{ employee_data.isr_to_apply|floatformat:2 }}</strong>
                                            </div>
                                            
                                            {% if employee_data.first_half_payment %}
                                            <div class="text-muted small mt-1 border-top pt-1">
                                                <i class="bi bi-calendar-week me-1"></i>
                                                First half: ${{ employee_data.first_half_payment.gross_salary|floatformat:2 }}
                                            </div>
                                            {% endif %}
                                            
                                        {% else %}
                                            <!-- Monthly payment -->
                                            <div class="d-flex justify-content-between small">
                                                <span class="text-muted">ISR:</span>
                                                <strong class="text-danger">${{ employee_data.payment.isr|floatformat:2 }}</strong>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="col-md-2">
                                    <div class="d-grid gap-2">
                                        {% if not employee_data.fully_approved and employee_data.has_workdays %}
                                        <button class="btn btn-sm btn-outline-warning" 
                                                onclick="approveEmployee({{ employee_data.employee.id }})">
                                            <i class="bi bi-check"></i> Approve
                                        </button>
                                        {% endif %}
                                        
                                        <!-- ISR Confirmation Button -->
                                        {% if period.is_second_half and not employee_data.payment.isr_locked %}
                                        <button class="btn btn-sm btn-outline-danger" 
                                                type="button"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#confirmIsrModal{{ employee_data.employee.id }}">
                                            <i class="bi bi-calculator"></i> Confirm ISR
                                        </button>
                                        {% elif period.is_second_half and employee_data.payment.isr_locked %}
                                        <button class="btn btn-sm btn-outline-secondary"
                                                onclick="unlockIsr({{ employee_data.payment.id }})">
                                            <i class="bi bi-unlock"></i> Unlock ISR
                                        </button>
                                        {% endif %}
                                        
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="viewDetails({{ employee_data.employee.id }})">
                                            <i class="bi bi-eye"></i> Details
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Work Days (Expandable) -->
                            <div class="row mt-3" id="details-{{ employee_data.employee.id }}" style="display: none;">
                                <div class="col-12">
                                    <h6 class="border-bottom pb-2">Work Days</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Hours</th>
                                                    <th>Regular</th>
                                                    <th>Overtime</th>
                                                    <th>Total</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for workday in employee_data.workdays %}
                                                <tr>
                                                    <td>{{ workday.date }}</td>
                                                    <td>{{ workday.productive_hours|floatformat:2 }}h</td>
                                                    <td>${{ workday.regular_pay|floatformat:2 }}</td>
                                                    <td>${{ workday.overtime_pay|floatformat:2 }}</td>
                                                    <td><strong>${{ workday.total_pay|floatformat:2 }}</strong></td>
                                                    <td>
                                                        {% if workday.is_approved %}
                                                        <span class="badge bg-success">Approved</span>
                                                        {% else %}
                                                        <span class="badge bg-warning">Pending</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted">
                                                        No work days in this period
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ISR Confirmation Modal for each employee -->
                    {% if period.is_second_half %}
                    <div class="modal fade" id="confirmIsrModal{{ employee_data.employee.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirm ISR - {{ period.get_period_type_display }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <form method="post" action="{% url 'nomina:confirm_isr' employee_data.payment.id %}">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Employee</label>
                                                    <p class="form-control-plaintext">
                                                        {{ employee_data.employee.user.get_full_name|default:employee_data.employee.user.username }}
                                                    </p>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">This Period Gross</label>
                                                    <p class="form-control-plaintext">
                                                        ${{ employee_data.total_gross|floatformat:2 }}
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                {% if employee_data.first_half_payment %}
                                                <div class="mb-3">
                                                    <label class="form-label">First Half Gross</label>
                                                    <p class="form-control-plaintext">
                                                        ${{ employee_data.first_half_payment.gross_salary|floatformat:2 }}
                                                    </p>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">Monthly Total Gross</label>
                                                    <p class="form-control-plaintext text-primary">
                                                        <strong>${{ employee_data.monthly_gross|floatformat:2 }}</strong>
                                                    </p>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <h6><i class="bi bi-calculator me-2"></i>ISR Calculation</h6>
                                            <p class="mb-1">
                                                <strong>Monthly Gross:</strong> ${{ employee_data.monthly_gross|floatformat:2 }}<br>
                                                <strong>Calculated Monthly ISR:</strong> ${{ employee_data.monthly_isr|floatformat:2 }}<br>
                                                <strong>ISR to apply this period:</strong> ${{ employee_data.isr_to_apply|floatformat:2 }}
                                            </p>
                                            <small class="text-muted">
                                                Based on monthly total of both periods. First half has no ISR applied.
                                            </small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="isrValue{{ employee_data.employee.id }}" class="form-label">
                                                Confirm ISR Amount for this period
                                                <span class="text-muted small">(Based on monthly total: ${{ employee_data.monthly_gross|floatformat:2 }})</span>
                                            </label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="isrValue{{ employee_data.employee.id }}"
                                                   name="isr_value"
                                                   step="0.01"
                                                   min="0"
                                                   value="{{ employee_data.isr_to_apply|floatformat:2 }}"
                                                   required>
                                            
                                            <div class="form-text">
                                                Adjust if necessary based on monthly total calculation. This will lock the ISR amount.
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="isrNotes{{ employee_data.employee.id }}" class="form-label">
                                                Notes (Optional)
                                            </label>
                                            <textarea class="form-control" 
                                                      id="isrNotes{{ employee_data.employee.id }}"
                                                      name="isr_notes"
                                                      rows="2"
                                                      placeholder="Add notes about ISR adjustment..."></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-danger">
                                            <i class="bi bi-check-circle me-1"></i> Confirm ISR
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% empty %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-people display-4 d-block mb-2"></i>
                        No employees in this campaign
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-people display-4 d-block mb-2"></i>
                No employees found for this period
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ISR Calculation Explanation Modal -->
<div class="modal fade" id="isrCalculationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ISR Calculation Methodology</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>How ISR is calculated in this system:</h6>
                <ol>
                    <li><strong>First Half of Month:</strong> No ISR is applied. Salary is accumulated for monthly calculation.</li>
                    <li><strong>Second Half of Month:</strong> ISR is calculated based on the <strong>total monthly salary</strong>.</li>
                    <li><strong>Monthly Calculation:</strong>
                        <ul>
                            <li>Monthly salary = First half gross + Second half gross</li>
                            <li>ISR is calculated on the monthly total</li>
                            <li>Entire ISR amount is applied in the second half period</li>
                        </ul>
                    </li>
                </ol>
                
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>Important Notes:</h6>
                    <ul class="mb-0">
                        <li>First half periods always have $0 ISR</li>
                        <li>Second half periods apply the full monthly ISR</li>
                        <li>Monthly ISR calculation follows Dominican Republic tax brackets</li>
                        <li>You can adjust the calculated ISR if needed before confirming</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function generatePayroll() {
    if (confirm('Are you sure you want to generate the payroll for this period? This will create payments for all employees.')) {
        window.location.href = "{% url 'nomina:generate_payroll' period.id %}";
    }
}

function approveAll() {
    if (confirm('Are you sure you want to approve all pending work days?')) {
        window.location.href = "{% url 'nomina:approve_all' period.id %}";
    }
}

function approveEmployee(employeeId) {
    if (confirm('Approve all days for this employee?')) {
        fetch("".replace('0', employeeId) + '?period_id={{ period.id }}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function unlockIsr(paymentId) {
    if (confirm('Unlock ISR for editing? This will allow changing the confirmed amount.')) {
        fetch("{% url 'nomina:unlock_isr' 0 %}".replace('0', paymentId), {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error unlocking ISR');
            }
        });
    }
}

function viewDetails(employeeId) {
    const detailsDiv = document.getElementById('details-' + employeeId);
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}

function toggleWorkday(workdayId) {
    fetch("{% url 'nomina:toggle_approval' 0 %}".replace('0', workdayId) + '?period_id={{ period.id }}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating work day');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
    // Text filter
    document.querySelectorAll('.campaign-filter').forEach(filter => {
        filter.addEventListener('input', function() {
            const campaignNum = this.getAttribute('data-campaign');
            const searchTerm = this.value.toLowerCase();
            
            document.querySelectorAll(`.campaign-${campaignNum}`).forEach(card => {
                const employeeName = card.querySelector('h6').textContent.toLowerCase();
                if (employeeName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
    
    // Status filter
    document.querySelectorAll('.status-filter').forEach(radio => {
        radio.addEventListener('change', function() {
            const name = this.getAttribute('name');
            const campaignNum = name.split('-')[1];
            const status = this.value;
            
            document.querySelectorAll(`.campaign-${campaignNum}`).forEach(card => {
                const cardStatus = card.getAttribute('data-status');
                
                if (status === 'all' || 
                    (status === 'approved' && cardStatus === 'approved') || 
                    (status === 'pending' && cardStatus === 'pending')) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });

    // Auto-focus first ISR modal input when opened
    document.addEventListener('shown.bs.modal', function(event) {
        const modal = event.target;
        if (modal.id && modal.id.startsWith('confirmIsrModal')) {
            const input = modal.querySelector('input[type="number"]');
            if (input) {
                input.focus();
                input.select();
            }
        }
    });
});
</script>
{% endblock %}
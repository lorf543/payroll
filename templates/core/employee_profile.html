{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container mt-4">
    <!-- Sistema de Tabs -->
    <ul class="nav nav-tabs mb-4" id="employeeTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" 
                    type="button" role="tab" aria-controls="profile" aria-selected="true">
                <i class="bi bi-person me-1"></i>Profile
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="idcard-tab" data-bs-toggle="tab" data-bs-target="#idcard" 
                    type="button" role="tab" aria-controls="idcard" aria-selected="false">
                <i class="bi bi-card-text me-1"></i>ID Card
            </button>
        </li>
    </ul>

    <!-- Contenido de los Tabs -->
    <div class="tab-content" id="employeeTabsContent">
        
        <!-- Tab 1: Profile -->
        <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card profile-card shadow-lg">
                        <!-- Encabezado del perfil -->
                        <div class="profile-header text-center py-4 bg-gradient-primary text-white">
                            <div class="profile-avatar mx-auto mb-3">
                                <span class="initials">
                                    {% if employee.user.first_name and employee.user.last_name %}
                                        {{ employee.user.first_name.0 }}{{ employee.user.last_name.0 }}
                                    {% else %}
                                        {{ employee.user.username.0|upper }}
                                    {% endif %}
                                </span>
                            </div>
                            <h2 class="mb-1">
                                {% if employee.user.get_full_name %}
                                    {{ employee.user.get_full_name }}
                                {% else %}
                                    {{ employee.user.username }}
                                {% endif %}
                            </h2>
                            <p class="mb-2">
                                {% if employee.position %}
                                    {{ employee.position.title }}
                                {% else %}
                                    Employee
                                {% endif %}
                            </p>
                            <div class="employee-status">
                                <span class="badge bg-success">Active</span>
                                <span class="badge bg-light text-dark ms-2">{{ employee.employee_code }}</span>
                            </div>
                        </div>
                        
                        <div class="card-body p-4">
                            <div class="row">
                                <!-- Columna izquierda: Información personal -->
                                <div class="col-md-6">
                                    <div class="section-block mb-4">
                                        <h4 class="section-title d-flex align-items-center mb-3">
                                            <i class="bi bi-person-circle me-2"></i>Personal Information
                                        </h4>
                                        <div class="info-list">
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Username</span>
                                                <span class="info-value text-muted">{{ employee.user.username }}</span>
                                            </div>
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Full Name</span>
                                                <span class="info-value text-muted">
                                                    {% if employee.user.get_full_name %}
                                                        {{ employee.user.get_full_name }}
                                                    {% else %}
                                                        Not specified
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Email</span>
                                                <span class="info-value text-muted">{{ employee.user.email }}</span>
                                            </div>
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Employee Code</span>
                                                <span class="info-value text-muted">{{ employee.employee_code }}</span>
                                            </div>
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Identification</span>
                                                <span class="info-value text-muted">{{ employee.identification }}</span>
                                            </div>
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Skills</span>
                                                <span class="info-value text-muted">{{ employee.skills_list }}</span>
                                            </div>
                                            <div class="info-item d-flex justify-content-between align-items-center py-2">
                                                <span class="info-label fw-medium">Gender</span>
                                                <span class="info-value text-muted">
                                                    {% if employee.gender %}
                                                        {{ employee.get_gender_display }}
                                                    {% else %}
                                                        Not specified
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Información de pago unificada -->
                                    {% if request.user.id == employee.user.id or request.user.is_superuser %}
                                        <div class="section-block mb-4">
                                            <h4 class="section-title d-flex align-items-center mb-3">
                                                <i class="bi bi-cash me-2"></i>Payment Information
                                            </h4>
                                            <div class="info-list">
                                                <!-- Método de pago -->
                                                <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                    <span class="info-label fw-medium">Payment Method</span>
                                                    <span class="info-value text-muted">
                                                        {% if employee.fixed_rate %}
                                                            <span class="badge bg-warning text-dark">Fixed Salary</span>
                                                        {% else %}
                                                            <span class="badge bg-info">Hourly Rate</span>
                                                        {% endif %}
                                                    </span>
                                                </div>

                                                <!-- Tarifa base -->
                                                <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                    <span class="info-label fw-medium">Base Rate</span>
                                                    <span class="info-value text-muted">
                                                        {{ employee.current_campaign.hour_rate }} 
                                                    </span>
                                                </div>
                                                
                                                <!-- Proyección mensual -->
                                                <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                    <span class="info-label fw-medium">Monthly Projection</span>
                                                    <span class="info-value text-success fw-bold">
                                                        {% if payment_stats %}
                                                            ${{ payment_stats.monthly_earnings|intcomma }}
                                                        {% else %}
                                                            Not available
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                
                                                <!-- Tipo de cálculo -->
                                                <div class="info-item d-flex justify-content-between align-items-center py-2">
                                                    <span class="info-label fw-medium">Calculation Type</span>
                                                    <span class="info-value text-muted">
                                                        {% if payment_stats %}
                                                            {{ payment_stats.pay_method|title }}
                                                        {% else %}
                                                            Not available
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Columna derecha: Información laboral -->
                                <div class="col-md-6">
                                    <div class="section-block mb-4">
                                        <h4 class="section-title d-flex align-items-center mb-3">
                                            <i class="bi bi-building me-2"></i>Work Information
                                        </h4>
                                        <div class="info-list">
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Department</span>
                                                <span class="info-value text-muted">
                                                    {% if employee.department %}
                                                        {{ employee.department.name }}
                                                    {% else %}
                                                        Not assigned
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Position</span>
                                                <span class="info-value text-muted">
                                                    {% if employee.position %}
                                                        {{ employee.position.name }}
                                                    {% else %}
                                                        Not assigned
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-block mb-4">
                                        <h4 class="section-title d-flex align-items-center mb-3">
                                            <i class="bi bi-card-checklist me-2"></i>Campaign Information
                                        </h4>
                                        <div class="info-list">
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Current Campaign</span>
                                                <span class="info-value text-muted">
                                                    {% if employee.current_campaign %}
                                                        {{ employee.current_campaign.name }}
                                                    {% else %}
                                                        No campaign assigned
                                                    {% endif %}
                                                </span>
                                            </div>

                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Shutdown Time</span>
                                                <span class="info-value text-muted">
                                                    {% if employee.current_campaign and employee.current_campaign.shutdown_time %}
                                                        {{ employee.current_campaign.shutdown_time|time:"g:i A" }}
                                                    {% else %}
                                                        Not set
                                                    {% endif %}
                                                </span>
                                            </div>

                                            <div class="info-item d-flex justify-content-between align-items-center py-2">
                                                <span class="info-label fw-medium">Login Status</span>
                                                <span class="info-value text-muted">
                                                    {%if employee.is_logged_in %}
                                                        <span class="badge bg-success">Online</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">Offline</span>
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-block mb-4">
                                        <h4 class="section-title d-flex align-items-center mb-3">
                                            <i class="bi bi-clock me-2"></i>Login History
                                        </h4>
                                        <div class="info-list">
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Last Login</span>
                                                <span class="info-value text-muted">
                                                    {% if employee.user.last_login %}
                                                        {{ employee.user.last_login|date:"M d, Y g:i A" }}
                                                    {% else %}
                                                        Never
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-block">
                                        <h4 class="section-title d-flex align-items-center mb-3">
                                            <i class="bi bi-bank me-2"></i> Banking Information
                                        </h4>
                                        <div class="info-list">
                                            <div class="info-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <span class="info-label fw-medium">Bank Name</span>
                                                <span class="info-value text-muted">
                                                    {{employee.bank_name}}
                                                </span>
                                            </div>
                                            <div class="info-item d-flex justify-content-between align-items-center py-2">
                                                <span class="info-label fw-medium">Bank account</span>
                                                <span class="info-value text-muted">
                                                    {{employee.bank_account}}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección de acciones -->
                            <div class="profile-actions mt-4 pt-3 border-top">
                                <div class="d-flex justify-content-center gap-3">
                                    {% if request.user == employee.user or request.user.is_superuser %}
                                        <a href="{% url 'edit_employee_profile' employee.id %}" class="btn btn-primary">
                                            <i class="bi bi-pencil me-2"></i>Edit Profile
                                        </a>
                                    {% endif %} 
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: ID Card -->
        <div class="tab-pane fade" id="idcard" role="tabpanel" aria-labelledby="idcard-tab">
            <div class="row justify-content-center py-4">

                <!-- FRONT SIDE -->
                <div class="col-auto mb-4">
                    <div class="idcard-cr80">

                        <!-- Header with logo + year -->
                        <div class="idcard-header">
                            <img src="{% static 'img/company_logo.png' %}" class="idcard-logo">
                            <p class="fw-bolder fs-3 pt-1">HELIUM HEALTH</p>
                            <div class="idcard-year">2025</div>
                        </div>

                        <!-- Main section -->
                        <div class="idcard-body">

                            <!-- Left section -->
                            <div class="idcard-left">
                                <div class="idcard-first">
                                    {{ employee.user.first_name|upper }}
                                </div>
                                <div class="idcard-last">
                                    {{ employee.user.last_name|upper }}
                                </div>

                                <div class="idcard-title">
                                    {% if employee.position %} 
                                        {{ employee.position.name|upper }}
                                    {% else %}
                                        EMPLOYEE
                                    {% endif %}
                                </div>

                                <div class="idcard-dept">
                                    {% if employee.department %}
                                        {{ employee.department.name|upper }}
                                    {% else %}
                                        DEPARTMENT
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Photo -->
                            <div class="idcard-photo">
                                {% if employee.profile_picture %}
                                    <img src="{{ employee.profile_picture.url }}">
                                {% else %}
                                    <img src="">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BACK SIDE -->
                <div class="col-auto">
                    <div class="idcard-cr80">

                        <div class="idcard-back-top">
                            <img src="{% static 'img/company_logo.png' %}" class="idcard-back-logo">
                        </div>

                        <div class="idcard-back-text">
                            There is a time for everything, and a season for every activity under the heavens:
                            a time to be born and a time to die, a time to plant and a time to uproot what is planted.
                        </div>

                        <div class="idcard-back-ref">
                            Ecclesiastes 3:1-2
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<script>
    // JavaScript para mejorar la experiencia de los tabs
    document.addEventListener('DOMContentLoaded', function() {
        // Guardar el tab activo en sessionStorage
        const tabs = document.querySelectorAll('#employeeTabs .nav-link');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-bs-target').substring(1);
                sessionStorage.setItem('activeEmployeeTab', tabId);
            });
        });
        
        // Restaurar el tab activo si existe
        const activeTab = sessionStorage.getItem('activeEmployeeTab');
        if (activeTab) {
            const tabElement = document.querySelector(`#${activeTab}-tab`);
            if (tabElement) {
                new bootstrap.Tab(tabElement).show();
            }
        }
    });
</script>
{% endblock content %}